// MCP Prompts 定義（既存の server 側プロンプトを集約）
import type { PromptMessage } from '@modelcontextprotocol/sdk/types.js';

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 型定義
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
export enum PromptLevel {
  BEGINNER = 'beginner',
  INTERMEDIATE = 'intermediate',
  ADVANCED = 'advanced',
}

export enum PromptCategory {
  ANALYSIS = 'analysis',
  VISUALIZATION = 'visualization',
  EDUCATION = 'education',
  WORKFLOW = 'workflow',
}

export interface PromptMetadata {
  level: PromptLevel;
  category: PromptCategory;
  estimatedTime?: string;
  prerequisites?: string[];
  tags?: string[];
}

export interface PromptDef {
  name: string;
  description: string;
  // server 側 register 用: 既存 messages をそのまま移行
  messages: Array<{
    role: 'system' | 'assistant' | 'user';
    content: any[];
  }>;
  // 表示用の引数メタ（存在しない既存もあるため任意）
  arguments?: Array<{ name: string; description?: string; required?: boolean }>;
  metadata?: PromptMetadata;
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 用語解説データベース（Phase 1 要求分のみ）
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
export interface TermExplanation {
  shortDef: string;
  analogy: string;
  ranges: Record<string, string>;
  usage: string;
  warning: string;
  related: string[];
}

export const termExplanations: Record<string, TermExplanation> = {
  RSI: {
    shortDef: '買われすぎ・売られすぎを数値化した指標',
    analogy: 'お店の人気度メーター',
    ranges: { '70': '買われすぎ（そろそろ下がるかも）', '30': '売られすぎ（そろそろ上がるかも）', default: '中立（どちらでもない）' },
    usage: '70以上で売り検討、30以下で買い検討',
    warning: '強いトレンドでは70以上・30以下が続くことがあります',
    related: ['MACD', 'ストキャスティクス'],
  },
  MACD: {
    shortDef: 'トレンドの勢いと転換点を見る指標',
    analogy: '自動車の加速・減速メーター',
    ranges: { goldenCross: 'ゴールデンクロス（買いシグナル）', deadCross: 'デッドクロス（売りシグナル）' },
    usage: '線が交差するタイミングで売買を検討',
    warning: 'ダマシも多いため他指標と併用',
    related: ['RSI', '移動平均線'],
  },
  ボリンジャーバンド: {
    shortDef: '価格が動く範囲を帯で示したもの',
    analogy: '道路の車線のようなもの',
    ranges: { upper: '上の帯（買われすぎの可能性）', lower: '下の帯（売られすぎの可能性）', middle: '中央線（平均価格）' },
    usage: '帯の外に出たら中央へ戻る可能性を考える',
    warning: '強いトレンドでは帯に沿って動き続けることがあります',
    related: ['移動平均線', 'ATR'],
  },
  板: {
    shortDef: '今出されている買い注文と売り注文のリスト',
    analogy: 'スーパーの値札と在庫数',
    ranges: { bid: '買い注文（買いたい人の希望価格と量）', ask: '売り注文（売りたい人の希望価格と量）' },
    usage: '厚い板の価格帯は突破しにくい「壁」になりやすい',
    warning: '板は一瞬で変わるため、スナップショットと捉える',
    related: ['スプレッド', '出来高'],
  },
  スプレッド: {
    shortDef: '買える最安値と売れる最高値の差',
    analogy: '店の買取価格と販売価格の差',
    ranges: { narrow: '狭い（100円以下）: 取引しやすい', wide: '広い（500円以上）: 価格が飛びやすい' },
    usage: 'スプレッドが狭い時の方が有利',
    warning: '流動性が低い時間帯は広がりやすい',
    related: ['板', '流動性'],
  },
  出来高: {
    shortDef: '一定期間に取引された数量',
    analogy: 'お店の来客数やレジ通過数',
    ranges: { high: '多い＝活発（注目度高い）', low: '少ない＝静か（値動き出にくい）', default: '平均的' },
    usage: '急増は注目イベントの可能性、トレンドの信頼性確認に併用',
    warning: '価格変動と併せて判断（出来高単独は誤認の恐れ）',
    related: ['トレンド', 'ボラティリティ'],
  },
  ローソク足: {
    shortDef: '一定期間の値動きを1本で表すチャート要素',
    analogy: '1日の天気をアイコンで表すイメージ',
    ranges: { long: '長い＝大きな値動き', short: '短い＝小さな値動き', default: '中程度' },
    usage: '実体とヒゲで勢い・拒否・反転の手がかり',
    warning: '1本だけで結論にせず、連続性や出来高も参照',
    related: ['トレンド', '出来高'],
  },
  移動平均線: {
    shortDef: '一定期間の平均価格をつないだ線',
    analogy: '道の傾き（上り坂/下り坂）',
    ranges: { bullish: '価格＞線＝強気傾向', bearish: '価格＜線＝弱気傾向', cross: '交差＝転換の兆し' },
    usage: '25/75/200などを組み合わせて方向性・支持抵抗を確認',
    warning: '遅行性があるため急変には鈍い',
    related: ['トレンド', 'ボラティリティ'],
  },
  トレンド: {
    shortDef: '価格が続いて動く方向性',
    analogy: '川の流れ（上流→下流）',
    ranges: { up: '上昇', down: '下降', range: '横ばい' },
    usage: '上昇は押し目買い、下降は戻り売りなど方針の基礎',
    warning: '時間軸で異なる方向が出るため軸の統一が必要',
    related: ['移動平均線', '出来高'],
  },
  ボラティリティ: {
    shortDef: '価格変動の大きさ',
    analogy: '波の高さ（荒波/凪）',
    ranges: { high: '高い＝大きく動く', low: '低い＝小さく動く', default: '平均的' },
    usage: 'リスク管理・ポジションサイズの目安、指標はATRやRVなど',
    warning: '高ボラは機会とリスクが同時に増える',
    related: ['出来高', '移動平均線'],
  },
};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 既存プロンプト（server.ts から移行）
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const promptsAll: PromptDef[] = [
  {
    name: 'bb_default_chart',
    description: 'Render chart with Bollinger Bands default (±2σ).',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: 'BB(±2σ)付きチャートを表示して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair (e.g., btc_jpy)', required: false },
      { name: 'type', description: 'Timeframe (e.g., 1day, 1hour)', required: false },
      { name: 'limit', description: 'Number of candles', required: false },
    ],
    metadata: { level: PromptLevel.INTERMEDIATE, category: PromptCategory.VISUALIZATION, tags: ['chart', 'bollinger-bands', 'visualization'] },
  },
  {
    name: 'candles_only_chart',
    description: 'Render plain candlestick chart only (no indicators).',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: 'ローソク足だけのチャートを表示して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
      { name: 'type', description: 'Timeframe', required: false },
      { name: 'limit', description: 'Number of candles', required: false },
    ],
    metadata: { level: PromptLevel.INTERMEDIATE, category: PromptCategory.VISUALIZATION, tags: ['chart', 'candles', 'simple'] },
  },
  {
    name: 'bb_extended_chart',
    description: 'Render chart with Bollinger Bands extended (±1/±2/±3σ). Use only if user explicitly requests extended.',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: 'BB拡張（±1/±2/±3σ）チャートを表示して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
      { name: 'type', description: 'Timeframe', required: false },
      { name: 'limit', description: 'Number of candles', required: false },
    ],
    metadata: { level: PromptLevel.ADVANCED, category: PromptCategory.VISUALIZATION, tags: ['chart', 'bollinger-bands', 'extended', 'advanced'] },
  },
  {
    name: 'ichimoku_default_chart',
    description: 'Render chart with Ichimoku default (Tenkan/Kijun/Cloud only).',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: '一目均衡表（標準）を表示して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
      { name: 'type', description: 'Timeframe', required: false },
      { name: 'limit', description: 'Number of candles', required: false },
    ],
    metadata: { level: PromptLevel.INTERMEDIATE, category: PromptCategory.VISUALIZATION, tags: ['chart', 'ichimoku', 'japanese'] },
  },
  {
    name: 'ichimoku_extended_chart',
    description: 'Render chart with Ichimoku extended (includes Chikou). Use only if user explicitly requests extended.',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: '一目均衡表（拡張・遅行含む）を表示して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
      { name: 'type', description: 'Timeframe', required: false },
      { name: 'limit', description: 'Number of candles', required: false },
    ],
    metadata: { level: PromptLevel.ADVANCED, category: PromptCategory.VISUALIZATION, tags: ['chart', 'ichimoku', 'extended', 'advanced'] },
  },
  {
    name: 'depth_analysis',
    description: 'Analyze current orderbook depth (bids/asks) and summarize liquidity/imbalance.',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: '板の状況（深さ）を分析して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
    ],
    metadata: { level: PromptLevel.INTERMEDIATE, category: PromptCategory.ANALYSIS, tags: ['orderbook', 'depth', 'liquidity'] },
  },
  {
    name: 'depth_chart',
    description: 'Render a depth-focused analysis (calls get_depth first).',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: '板の状況を見て必要なら可視化して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
    ],
    metadata: { level: PromptLevel.INTERMEDIATE, category: PromptCategory.VISUALIZATION, tags: ['orderbook', 'depth', 'chart'] },
  },
  {
    name: 'flow_analysis',
    description: 'Analyze recent transactions-derived flow metrics with numeric tags and concise conclusion.',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: 'フロー（出来高・CVD）を分析して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
      { name: 'limit', description: 'Number of transactions', required: false },
      { name: 'bucketMs', description: 'Bucket size in milliseconds', required: false },
    ],
    metadata: { level: PromptLevel.INTERMEDIATE, category: PromptCategory.ANALYSIS, tags: ['flow', 'cvd', 'transactions'] },
  },
  {
    name: 'orderbook_pressure_analysis',
    description: 'Assess orderbook pressure in ±pct bands with numeric tags and concise conclusion.',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: '板の圧力（±%帯域）を評価して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
      { name: 'delayMs', description: 'Delay in milliseconds', required: false },
      { name: 'bandsPct', description: 'Percentage bands', required: false },
    ],
    metadata: { level: PromptLevel.INTERMEDIATE, category: PromptCategory.ANALYSIS, tags: ['orderbook', 'pressure', 'bands'] },
  },
  {
    name: 'multi_factor_signal',
    description: 'Quick multi-factor market signal: flow metrics, volatility and indicators (no chart unless asked).',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: '総合シグナル（フロー/ボラ/指標）を素早く評価して' }] },
    ],
    arguments: [
      { name: 'pair', description: 'Trading pair', required: false },
      { name: 'limit', description: 'Number of data points', required: false },
      { name: 'bucketMs', description: 'Bucket size for flow analysis', required: false },
      { name: 'type', description: 'Timeframe', required: false },
      { name: 'volLimit', description: 'Limit for volatility metrics', required: false },
      { name: 'indLimit', description: 'Limit for indicators', required: false },
    ],
    metadata: { level: PromptLevel.INTERMEDIATE, category: PromptCategory.WORKFLOW, tags: ['comprehensive', 'multi-factor', 'signal'] },
  },
  // --- Phase 1-2: Beginner prompts ---
  {
    name: 'beginner_market_check',
    description: '【初心者向け】今、買い時？売り時？をわかりやすく説明',
    arguments: [
      { name: 'pair', description: '通貨ペア（例: btc_jpy, eth_jpy）', required: false },
    ],
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: '今、買い時？売り時？を初心者向けに教えて' }] }
    ],
    metadata: {
      level: PromptLevel.BEGINNER,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '30秒',
      tags: ['beginner', 'analysis', 'buy-sell-timing'],
    },
  },
  {
    name: 'beginner_chart_view',
    description: '【初心者向け】チャートの見方を解説しながら表示',
    arguments: [
      { name: 'pair', description: '通貨ペア（例: btc_jpy, eth_jpy）', required: false },
      { name: 'days', description: '表示する日数（デフォルト: 60日）', required: false },
    ],
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: 'チャートを見せて。見方も初心者向けに教えて' }] }
    ],
    metadata: {
      level: PromptLevel.BEGINNER,
      category: PromptCategory.VISUALIZATION,
      estimatedTime: '1分',
      prerequisites: [],
      tags: ['beginner', 'chart', 'education', 'candlestick', 'moving-average'],
    },
  },
  {
    name: 'beginner_trend_check',
    description: '【初心者向け】今の流れは上昇？下降？横ばい？',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: '今のトレンドを初心者向けに教えて' }] }
    ],
    metadata: {
      level: PromptLevel.BEGINNER,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '30秒',
      tags: ['beginner', 'trend']
    },
  },
  {
    name: '🔰 BTCの値動きを分析して',
    description: 'ビットコインの最近の価格動向とトレンドを初心者向けに分析',
    messages: [
      {
        role: 'assistant', content: [{
          type: 'text', text: `最近のBTCの動きを初級者向けに分析してください。

【表現ルール】
1. 専門用語は「わかりやすい言葉（正式名称）」で併記
   例: 加熱度（RSI）、平均価格（移動平均線）、トレンドの雲（一目均衡表）
2. 初出の指標には1行説明を添える
3. 数値だけでなく「意味」を説明
4. 指標間の関係性・整合性を明示
5. チャート不要、テキストのみ
6. 視覚的なゲージや絵文字を活用して直感的に理解できるようにする

【分析の流れ（ツールは2つ）】
1) analyze_market_signal(pair="btc_jpy", type="1day")
   → 総合スコア、SMA詳細、補足指標（RSI・一目・MACD）を取得
2) get_indicators(pair="btc_jpy", type="1day", limit=50)
   → RSI推移（直近7日間）を取得して視覚化

【出力形式】

# 📊 BTC分析レポート

## 現在の状況

**現在価格：XX,XXX,XXX円**

**総合スコア：XX / 100**（[解釈テキスト]）

\`\`\`
-100 ◄──────────────┼──────────────► +100
       弱気        中立       強気
                    ▲
                  今ココ
\`\`\`

## 3つの視点で見る

### 1️⃣ 加熱度（RSI）

**RSIとは**：0-100で測る指標。30以下=売られすぎ、70以上=買われすぎを示します。

**現在値：XX.X**
\`\`\`
[████░░░░░░] XX/100
\`\`\`
↑ [状態の説明]（例：売られすぎに近い、30以下で反発期待）

**📊 直近7日間の推移**：
[get_indicators の本文から「RSI推移（直近7日）」を引用]
└─ [推移の解釈] [📈上昇中/📉下降中/→横ばい] [一言コメント]

**注意点**：
[RSI特有の注意点を1行で]（例：強いトレンド中は30以下・70以上が続くこともあります）

※ゲージの作り方：RSI値を10で割った数だけ█、残りは░（10ブロック制）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### 2️⃣ トレンドの強さ（移動平均線）

| 期間 | 移動平均価格 | 価格との差 | 判定 |
|------|-------------|-----------|------|
| 短期（25日） | XX,XXX,XXX円 | +X.X% 上/下 | 🟢強気/🔴弱気/🟡中立 |
| 中期（75日） | XX,XXX,XXX円 | +X.X% 上/下 | 🟢強気/🔴弱気/🟡中立 |
| 長期（200日） | XX,XXX,XXX円 | +X.X% 上/下 | 🟢強気/🔴弱気/🟡中立 |

**移動平均線とは**：過去の平均価格を結んだ線。トレンド（方向性）を見る基本指標です。

**今の状態**：
[全体的な配置とトレンドを1-2行で]
（例：全ての移動平均線が価格の上にある → **弱気構造**。価格が短期線（約XX万円）を明確に超えない限り、本格的な上昇トレンドとは言えません）

**直近の動き**：
[クロスやその他の動きがあれば記載]
（例：9日前に短期線（25日）が中期線（75日）を上抜け（ゴールデンクロス）。短期的な反発開始のサインですが、まだ価格は全ての平均線の下にあります）

※判定の見方：
- 🟢強気：価格がその平均線より上（上昇傾向）
- 🔴弱気：価格がその平均線より下（下落傾向）
- 🟡中立：ほぼ同じ位置（転換期・横ばい）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### 3️⃣ トレンドの雲（一目均衡表）

**一目均衡表とは**：価格と「雲」（抵抗・支持帯）の位置関係でトレンドを判断する指標です。

**今の状態**：

現在位置：[雲の上🟢/雲の中🟡/雲の下🔴]
- 雲との距離：±X.X%
- 雲の厚さ：X.X%（厚いほど抵抗/支持が強い）

[状態の説明を2-3行で]（例：雲の下にいるため、上昇には雲を突破する必要があります。雲は厚く、強い抵抗として機能しています）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### 📊 3指標の関係性

**整合性**：

| 指標 | 状態 | 判定 |
|------|------|------|
| RSI | XX | 🟢/🔴/🟡 |
| 移動平均線 | [配置] | 🟢/🔴/🟡 |
| 一目均衡表 | [位置] | 🟢/🔴/🟡 |

**総合解釈**：
[3つの指標を統合した解釈を2-3行で]
（例：「RSIは反発余地があり売られすぎ圏から脱出中🟡、しかし移動平均線・一目ともに弱気構造🔴。短期的な反発はあっても、上値は重い展開が予想されます」）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 🎯 今後の注目ポイント

① **RSIが40回復** → 反発継続の兆し

現在：XX → 目標：40（あと+Xpt）

[意味説明]（例：40を超えると「売られすぎ」から完全脱出。上昇の勢いが出てくる目安です）

② **価格が短期平均（25日）を上抜け**

現在：XX,XXX,XXX円

目標：XX,XXX,XXX円（+X.X%、約XX万円上）

[意味説明]（例：これが最初の壁。ここを明確に超えると、トレンド転換への期待が高まります）

③ **雲への接近/突破** → 強弱の変化

現在：雲の[上/中/下]（[上限/下限]まで約XX万円、±X.X%）

[意味説明と状態]（例：⚠️ 雲の下限まで接近すると重要な局面です。しかし雲は約XXX万円分の厚さがあるため、突破には相当な勢いが必要です）

## 📝 まとめ

**一言の結論**：
[全体を踏まえた一言結論]（例：「反発の芽は出つつあるが、まだ弱気構造。無理のない運用を心がけましょう」）

**補足**：
- この分析は日足（1日単位）の技術指標に基づいています
- 重要なニュース（規制・大手企業の動向など）や出来高の急増があれば、評価は大きく変わる可能性があります
- 短期的な値動きは予測困難です。長期的な視点を持つことをお勧めします

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。` }]
      }
    ],
    metadata: {
      level: PromptLevel.BEGINNER,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '30秒',
      tags: ['beginner', 'btc', 'trend', 'price']
    }
  },
  {
    name: '🔰 ビットコインは今後どうなりそう？',
    description: 'テクニカル指標を使って、初心者にもわかりやすく今後の見通しを説明（分析のみ、描画なし）。',
    messages: [
      { role: 'assistant', content: [{ type: 'text', text: 'ビットコインの価格を予想して。専門用語は必ず💡で平易な説明を添えてください。初心者にもわかりやすく、テクニカル指標を根拠に説明して。\n\n【手順（ツールは最大3回まで）】\n1) SMA配置とクロス確認（analyze_market_signal: type=1day, windows=[14,20,30]）\n   ※ 内部で計算されるSMA配置とクロス情報を取得\n2) 直近の買い/売りの流れを確認（get_flow_metrics: 短期バケット）\n3) 形成中の反転サインを確認（detect_patterns: type=1day, limit=150, view=\"detailed\", includeForming=true, includeCompleted=false）\n   ※ 形成中パターンのみ取得（status=\"forming\" または \"near_completion\"）\n   ※ 複数パターンが検出された場合、短期・中期の両方を必ず説明\n\n【総合判断の計算ルール】\n1. **トレンド構造スコア算出（60%）**\n   - SMA配置と直近クロスから-3～+3で評価\n   - 配置状態：\n     * 価格 > 短期 > 中期 > 長期（完全な上昇順）: +3\n     * 価格 > 短期 > 中期、長期は価格より上: +2\n     * 価格 > 短期、中長期は価格より上: +1\n     * 全ての移動平均線が価格より上（下降順）: -3\n     * 価格 > 長期 > 中期 > 短期（一部逆転）: -1\n   - クロス加算：\n     * ゴールデンクロス発生（10日以内）: +1（加算）\n     * デッドクロス発生（10日以内）: -1（減算）\n\n2. **パターン形成スコア算出（35%）**\n   - 検出されたパターンの種類と完成度から-3～+3で評価\n   - 上昇転換パターン（H&S底、逆H&S、下降ウェッジなど）:\n     * 80%以上: +3\n     * 60-79%: +2\n     * 40-59%: +1\n   - 下落転換パターン（H&S天井、ダブルトップなど）:\n     * 80%以上: -3\n     * 60-79%: -2\n     * 40-59%: -1\n   - パターンなし: 0\n\n3. **短期買い圧力（5%、参考程度）**\n   - 70%以上: 「短期では買い優勢」と付記\n   - 30%以下: 「短期では売り優勢」と付記\n   - 30-70%: 特に言及しない\n\n4. **合計スコア = (トレンド構造スコア)×0.6 + (パターン形成スコア)×0.35**\n   - +2.0以上: 上昇継続の見込み 📈\n   - +1.0～+1.9: 上昇の可能性あり 📊📈\n   - +0.5～+0.9: 底打ち、反発待ち 📉→📈\n   - -0.4～+0.4: 方向感なし、様子見推奨 ↔️\n   - -0.9～-0.5: 天井、調整入りか 📈→📉\n   - -1.9～-1.0: 下落の可能性あり 📊📉\n   - -2.0以下: 下落継続の見込み 📉\n\n【出力フォーマット】\n\n# 📊 今後の見通し：ビットコイン\n\n📅 YYYY/MM/DD HH:MM JST  \n💰 現在価格：¥XX,XXX,XXX\n\n## 📊 総合判断\n\n**【方向感】** [上昇継続の見込み / 上昇の可能性あり / 底打ち、反発待ち / 方向感なし、様子見推奨 / 天井、調整入りか / 下落の可能性あり / 下落継続の見込み] [絵文字]\n\n### 判断の根拠\n\n| 視点 | 状態 | 判定 |\n|------|------|------|\n| 📐 **トレンド構造**<br>（移動平均線） | [配置状態を簡潔に]<br>[直近のクロス情報があれば記載] | [✅/⚠️/❌] [判定] |\n| 🔍 **短期の勢い**<br>（直近1時間） | 買い XX% vs 売り XX% | [✅/⚠️/❌] [判定] |\n| 🔮 **反転パターン** | [パターン名] XX%完成<br>目標: ¥XX,XXX,XXX | [✅/⚠️/❌] [判定] |\n\n💡 **[3つの視点を統合した解釈を1-2行で]**  \n（例：トレンド構造は弱気だが、短期の買い優勢と反転パターンが上昇を示唆。¥14,500,000を上抜けすれば本格的な転換の可能性があります）\n\n## 📐 価格と移動平均線の位置関係\n\n💡 **移動平均線とは**：過去X日間の平均価格をつないだ線。価格がこの線より上にあれば「強気」、下にあれば「弱気」と判断されます。\n\n### 直近の重要な動き\n\n（クロスがある場合のみ表示）  \n✅ X日前に「**[ゴールデンクロス/デッドクロス]**」発生\n\n💡 **[ゴールデンクロス/デッドクロス]とは**：  \n短期の移動平均線（25日）が中期の移動平均線（75日）を[上抜け/下抜け]した状態。  \n一般的に「[底打ち/天井]のサイン」とされています。\n\n### 現在の配置\n\n**トレンド判定：** [強気/弱気/不明瞭]（配置：[上昇順/下降順/混在]）\n\n| 期間 | 移動平均価格 | 価格との差 | 位置 |\n|------|-------------|-----------|------|\n| 短期（25日） | ¥XX,XXX,XXX | ±X.X% | [上/下] |\n| 中期（75日） | ¥XX,XXX,XXX | ±X.X% | [上/下] |\n| 長期（200日） | ¥XX,XXX,XXX | ±X.X% | [上/下] |\n\n💡 [配置の具体的な意味を1-2行で]  \n（例：全ての移動平均線が価格の上にあるため、弱気構造です。ただし、短期線（25日）が中期線（75日）を上抜けており、徐々に上昇の兆しが見え始めています）\n\n## 🔍 最近の売買の流れ\n\n**買い比率：XX%** / 売り比率：XX%  \n判定：[買い優勢 / 売り優勢 / 拮抗]\n\n💡 直近1時間の実際の取引データから算出。買い比率が高いほど「積極的に買っている人が多い」ことを示します。  \n[フローの解釈を1行で]（例：やや売り優勢。短期的には慎重姿勢が続いています）\n\n## 🔮 注目パターン\n\n### 短期パターン（検出された場合のみ）\n\n📊 **パターン名：[パターン名]**\n\n💡 **[パターン名]とは**：  \n[パターンの意味を初心者向けに2-3行で説明]  \n（例：価格が下落しながら値幅が徐々に狭まっていくパターン。下落の勢いが弱まっているサインで、完成すると上昇反転しやすい形です）\n\n**完成度：** [■■■■■□□□□□] XX%  \n**重要ライン：** ¥XX,XXX,XXX\n\n💡 このラインを[上抜け/下抜け]すると、パターンが完成し[上昇/下落]の勢いが強まる可能性があります。\n\n### 中期パターン（検出された場合のみ）\n\n📊 **パターン名：[パターン名]**\n\n💡 **[パターン名]とは**：  \n[パターンの意味を初心者向けに2-3行で説明]\n\n**完成度：** [■■■■■□□□□□] XX%  \n**価格変動幅：** ¥XX,XXX,XXX ～ ¥XX,XXX,XXX  \n**重要ライン：** ¥XX,XXX,XXX\n\n💡 このラインを[上抜け/下抜け]すると、パターンが完成し[上昇/下落]の勢いが強まる可能性があります。\n\n## 🎯 シナリオ分析\n\n### 短期（～1週間）\n\n[具体的な見通しを1-2行で]\n\n#### 注目条件\n\n• もし○○なら → [影響を簡潔に]  \n• もし○○なら → [影響を簡潔に]\n\n### 中期（～1ヶ月）\n\n[具体的な見通しを1-2行で]\n\n#### 注目条件\n\n• もし**短期平均（25日）を明確に[上抜け/下抜け]**したら → 短期トレンド転換の可能性  \n  💡 「ブレイク」＝重要なラインを明確に超えること  \n• もし**長期平均（200日）を明確に[上抜け/下抜け]**したら → 大きなトレンド転換の可能性  \n• もし**出来高が急増**したら → 反転/加速の可能性\n\n## ✅ 次の一手（参考例）\n\n1. [行動例1]（例：様子見を推奨。明確なトレンド転換サインを待つ）\n2. [行動例2]（例：少額で試す場合は、損切りラインを事前に決めておく）\n3. [行動例3]（例：重要ラインでの反応を確認してから判断）\n\n⚠️ **リスク要因：** [外れうる条件を1つ]（例：急なニュースで流れが一変する可能性があります）\n\n---\n\n【言い換えルール】\n- RSI → 加熱度（RSI）\n- MACD → 勢いの変化（MACD）\n- ボラティリティ → 値動きの荒さ（ボラティリティ）\n- SMA/移動平均線 → 平均価格（移動平均線）\n- クロス → 交差\n- ブレイク → 突破/抜ける\n- アペックス → 収束点/先端部分\n\n【専門用語説明ルール】\n- 専門用語の初出時には必ず💡で平易な説明を添える\n- 説明は2-3行以内で、具体例を含める\n- 「一般的に～とされています」のように、絶対ではないことを示す\n\n【視覚要素のルール】\n- プログレスバーは `[■■■■■□□□□□]` 形式（10ブロック制）\n- 重要数値（価格・パーセント）は必ず表示\n- 絵文字は情報分類に使用（📊📈📐🔍🔮✅⚠️💡）\n- 装飾線（━━━）は使用しない。全て見出し（##/###/####）で構造化\n\n---\n\n⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。\n\n板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。\n\n投資判断はご自身の責任でお願いします。' }] },
    ],
    metadata: { level: PromptLevel.BEGINNER, category: PromptCategory.ANALYSIS, tags: ['beginner', 'forecast', 'flow', 'forming'] },
  },
  {
    name: '🔰 今のBTCって買い時？',
    description: '一目均衡表 × 移動平均線（20/50/200）に特化して、現在の相場バランスと長期トレンドを横断的に評価し、「今、買い時か？」を結論づける専用プロンプト。',
    messages: [
      {
        role: 'assistant', content: [{
          type: 'text', text: `今のBTCって買い時？

【分析ポリシー（必ず遵守）】
- チャートは出さない。数値スナップショット系ツールのみ使用
- 一目均衡表と移動平均線を主軸に評価
- 初心者向けに専門用語を避け、シンプルに
- （）を多用せず、読みやすく
- 数値は必要最小限、小数点以下は四捨五入

【使うツール（この順）】
1) analyze_ichimoku_snapshot（type=1day, limit=120）
2) analyze_sma_snapshot（type=1day, limit=220, periods=[20,50,200]）
3) analyze_candle_patterns（allow_partial_patterns=false）
   → パターンがあれば render_candle_pattern_diagram でSVG生成

【出力フォーマット（5ブロック、順番固定）】
結論を先に
① 今の相場の状態
② 短期サイン（2本足パターン）
③ 注意すべきポイント
④ 重要な価格ライン
⑤ アドバイスとリスク

---

## 結論を先に

🔴/🟡/🟢 **買い時ではありません / 様子見 / 買い時**

今の状態: 価格が上がり続けている / 横ばい / 下がり続けている
2つの分析ツールの判断: どちらも「上がる/下がる可能性が高い」
短期サイン: [パターン名]が出た / 明確なサインなし
今日/最近のサイン: 重要な上昇/下落サインが出た → もう少し待つ/継続に期待

---

## ① 今の相場の状態

### 📖 この分析で使う2つの指標

一目均衡表 = 日本生まれのチャート分析ツール
- 雲: 価格が通りにくいゾーン。雲の上なら上がりやすく、下なら上がりにくい
- 短期線・中期線: 2本の線の位置で短期の勢いを判断
- 値動きの勢い: 26日前と比べてどうか

移動平均線 = 過去の平均価格の線
- 20日移動平均: 直近1ヶ月の流れ
- 50日移動平均: 直近2〜3ヶ月の流れ
- 200日移動平均: 直近10ヶ月の流れ

💡 価格と平均線の位置関係でトレンドを判断。ただし、平均から大きく離れすぎると反動に注意。2つの指標（一目均衡表と移動平均線）が同じことを言っているかで精度を上げます。

---

### 【一目均衡表】👉 強気/中立/弱気 🟢/🟡/🔴

💭 一目均衡表とは: 雲でトレンドを見る指標（雲の上=強気、下=弱気）

#### 今の価格の位置:

**パターン1: 雲の下（弱気）**
\`\`\`
    ╔═══════════════════════╗
    ║ XX,XXX,XXX円  雲上端  ║
    ║                       ║
    ║   雲の厚さ X.X%       ║
    ║                       ║
    ║ XX,XXX,XXX円  雲下端  ║
    ╚═══════════════════════╝
         ↑ +X.X% 上方
 📍 XX,XXX,XXX円 ━━ 現在価格
\`\`\`

💡 価格が雲の下 → 上に戻りにくい状態
- 雲（壁）を突破するには +X.X% の上昇が必要
- 雲の厚さが X.X% あるので、簡単には抜けられない

**パターン2: 雲の上（強気）**
\`\`\`
 📍 XX,XXX,XXX円 ━━ 現在価格
         ↓ -X.X% 下方
    ╔═══════════════════════╗
    ║ XX,XXX,XXX円  雲上端  ║
    ║                       ║
    ║   雲の厚さ X.X%       ║
    ║                       ║
    ║ XX,XXX,XXX円  雲下端  ║
    ╚═══════════════════════╝
\`\`\`

💡 価格が雲の上 → 上がりやすい状態
- 下に雲（壁）があるので、下がりにくい
- もし雲まで下がっても、X.X% の厚さが下支えになる

**パターン3: 雲の中（不透明）**
\`\`\`
    ╔═══════════════════════╗
    ║ XX,XXX,XXX円  雲上端  ║
    ║                       ║
    ║         ↑ +X.X%       ║
    ║ 📍 XX,XXX,XXX円 現在価格 ║
    ║   雲の厚さ X.X%       ║
    ║         ↓ -X.X%       ║
    ║                       ║
    ║ XX,XXX,XXX円  雲下端  ║
    ╚═══════════════════════╝
\`\`\`

💡 雲の中 → 方向が定まっていない
- 上抜けすれば上がりやすくなる（+X.X%で脱出）
- 下抜けすれば下がりやすくなる（-X.X%で脱出）

#### その他の判断材料:

- 短期線と中期線: 短期線が上/下 → 短期的な勢いは上向き/下向き
- 値動きの勢い: 26日前より上/下 → 流れが続いている/変わりつつある

#### これは何を意味する？

【雲の下にいる場合】
- 価格が下がりやすい状態が揃っています
  - 価格が「雲」より下 → 上に戻りにくい
  - 雲を突破するには +X.X% の上昇が必要
  - 雲の厚さが X.X% = 簡単には抜けられない壁
- → まだ下がる可能性が高い / 様子見推奨

【雲の上にいる場合】
- 価格が上がりやすい状態が揃っています
  - 価格が「雲」より上 → 下がりにくい
  - 下に厚さ X.X% の壁（雲）が下支え
  - 短期的な調整があっても雲が守る
- → 上昇継続の可能性が高い / 押し目を待つのも一案

【雲の中にいる場合】
- 方向が定まっていない状態
  - 上抜け（+X.X%）すれば上昇転換
  - 下抜け（-X.X%）すれば下落継続
- → 雲を抜ける方向を確認してから判断

---

### 【移動平均線】👉 強気/中立/弱気 🟢/🟡/🔴

💭 移動平均線とは: 過去の平均価格を線でつないだもの
- 20日移動平均 = 直近1ヶ月の「平均的な値段」
- 50日移動平均 = 直近2〜3ヶ月の「平均的な値段」
- 200日移動平均 = 直近10ヶ月の「平均的な値段」

📊 見方:
- 価格が平均より上 = 上昇トレンド（強気の流れ）
  → ただし平均から大きく離れていると調整で下がる可能性も
- 価格が平均より下 = 下落トレンド（弱気の流れ）
  → ただし平均から大きく離れていると反発で上がる可能性も
- 価格が平均付近 = トレンドの転換点や様子見の状態
- 3本の線が上向き = 全体的に上昇の流れ
- 3本の線が下向き = 全体的に下落の流れ

#### 現在の位置:

- 現在価格: XX,XXX,XXX円

3つの移動平均線との距離:
- 20日移動平均: 現在より X%上/下 📈/📉 上向き/横ばい/下向き
- 50日移動平均: 現在より X%上/下 📈/📉 上向き/横ばい/下向き
- 200日移動平均: 現在より X%上/下 📈/📉 上向き/横ばい/下向き
→ 全ての平均線の上/下 にいる状態

直近の重要な動き:
- X日前: 20日が50日/200日より上/下になった（上昇/下落の勢いが強まったサイン）

#### これは何を意味する？

- 価格が平均より安い/高い状態が続いている
- 上昇に転じるには X% 以上の値上がりが必要 など、次の条件を明示

---

### 【2つの指標は何と言っている？】

✅ **両方とも「上がる/下がる可能性が高い」で一致**
- 一目も移動平均線も同じ判断 → 信頼性が高い
- 短期・中期・長期のすべてが同じ方向

⚠️ **指標が矛盾**
- 一目は上だが、移動平均線は下 など → 様子見

---

## ② 短期サイン（2本足パターン）

※パターンがある場合:

✅ **[パターン名]が出ました**

[日付]に[パターン名]というサインが出ました。
これは[上がる/下がる]サインで、過去のデータでは翌日に[上がった/下がった]ことが[XX%]あります。

[SVG図を表示: render_candle_pattern_diagram を呼び出し]

ただし、あくまで短期的なサインです。一目や平均線と合わせて判断してください。

※パターンがない場合:

ℹ️ **明確な短期サインは出ていません**

直近5日間では、特徴的な反転サインは見つかりませんでした。

---

## ③ 注意すべきポイント

警戒シグナル（1〜3項目）:
1. 今日、重要な上昇/下落サインが出ました → しばらく継続の可能性
2. 価格が雲の中 → 方向が不明瞭、様子見
3. 長期の流れは上だが価格は大きく下 → 長期も崩れるリスク

---

## ④ 重要な価格ライン

💭 価格の壁とサポート: 価格が跳ね返されやすいライン
- 🔴 上値の壁 = これを超えると上昇が加速
- 🟢 下値のサポート = これを割ると下落が加速

**注意: 一目均衡表と移動平均線から検出できたデータのみを使用してください。憶測の心理的節目（例: 13,000,000円、12,500,000円など）は含めないでください。**

\`\`\`
価格マップ

【上値の壁】

🔴 XX,XXX,XXX円 ★★★ 強い抵抗ゾーン（雲の上限）(+XX.X%)
│
│        雲の厚さ X.X% = 厚い壁
│
🔴 XX,XXX,XXX円 ★★★ 雲の下限 (+XX.X%)
│
│        ⚠️ ここを明確に超えないと上昇転換しない
│
🔴 XX,XXX,XXX円 ★★ 200日移動平均（長期の壁）(+XX.X%)
│
│
🔴 XX,XXX,XXX円 ★★ 50日移動平均（中期の壁）(+XX.X%)
│
│
🔴 XX,XXX,XXX円 ★★ 20日移動平均（短期の壁）(+XX.X%)
│
│
🔴 XX,XXX,XXX円 ★ 短期線（一目均衡表）(+X.X%)
│
├─────────────────────────────
📍 XX,XXX,XXX円 ← 今の価格
├─────────────────────────────

【下値のサポート】

│
🟢 XX,XXX,XXX円 ★ 中期線（一目均衡表）(-X.X%)
│
│
🟢 XX,XXX,XXX円 ★★ 20日移動平均（短期サポート）(-XX.X%)
│
│
🟢 XX,XXX,XXX円 ★★ 50日移動平均（中期サポート）(-XX.X%)
│
│
🟢 XX,XXX,XXX円 ★★ 200日移動平均（長期サポート）(-XX.X%)
│
│        ⚠️ 長期トレンドが崩れる重要ライン

【今の状況まとめ】
- 上昇するには: 最低でも +X.X% の上昇が必要（雲の下限 XX,XXX,XXX円を突破）
- 下落リスク: -X.X% 下がると XX,XXX,XXX円（20日/50日/200日移動平均のいずれか最も近いライン）
- 最重要ライン: XX,XXX,XXX円（雲の下限/上限 または 最も近い移動平均線）
\`\`\`

---

## ⑤ アドバイスとリスク

🔴/🟡/🟢 **買い時ではない / 様子見 / 買い時**

現在の状況:
- 一目: 価格と雲の関係、短期線/中期線、勢い
- 平均線: 3本の向き、価格との位置、直近の重要サイン
- 短期: [パターン名]が出た / サインなし

初心者向けアドバイス:
- 一目と平均線は[上向き/横ばい/下向き]、短期サインは[あり/なし]
- 今は買わない/様子見/買うなら少額 → 理由を1〜2行
- 待つべきサイン: 価格がXX,XXX,XXX円を明確に超える/割る など

リスク:
- このままの方向なら XX,XXX,XXX円 も視野
- 特に注意: XX,XXX,XXX円を超える/割ると加速の可能性

---

【数値の書き方ルール】
- 価格: 14,582,982円（カンマ区切り）
- パーセント: 10%（四捨五入）
- マイナス表記は避ける（例: 現在より10%上）
- 具体的な金額は必要最小限

【絵文字】
- 判定: 🟢/🟡/🔴   トレンド: 📈/📉   警告: ⚠️   チェック: ✅ / ❌

【注意事項】
- 断定を避け、数値根拠ベースで。結論は明確に（買い時/様子見/買い時ではない）

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。`
        }]
      }
    ],
    metadata: {
      level: PromptLevel.BEGINNER,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '30秒',
      tags: ['beginner', 'btc', 'buy-timing', 'ichimoku', 'moving-average']
    }
  },

  // === Intermediate prompts (new) ===
  {
    name: '中級：主要指標でBTCを分析して',
    description: '中級者向け：RSI/MACD/ボリンジャーバンド/一目均衡表/移動平均線を一括取得して総合的に分析',
    messages: [
      {
        role: 'assistant',
        content: [{
          type: 'text',
          text: `代表的な指標を使ってBTCを分析して

【使用ツール】
get_indicators (pair=btc_jpy, type=1day, limit=200)

【分析方針】
1. 総合判定から全体像を把握
2. 各指標を横断的に確認
3. 矛盾する指標があれば明示
4. 次の注目ポイントを具体的に

【出力フォーマット】
※ 横線（━/─）は使わず、Markdownの見出し（# / ## / ###）で区切ること
※ 補足行（└ で始まる説明）は行頭に「└」を置き、必ず改行して1行ずつ縦に並べる

# 📊 BTC/JPY 日足分析レポート

🔴/🟡/🟢 判定：[強気/中立/弱気]（一言で状態）

現在価格: XX,XXX,XXX円（前日比: ±X.X%）

## 📈 勢い指標

### 🌡️ RSI（加熱度）: [数値]

\`\`\`
███░░░░░░░ やや弱気
\`\`\`

RSIとは: 0-100で「買われすぎ/売られすぎ」を測る指標
└ 30以下 = 売られすぎ → 反発しやすい
└ 70以上 = 買われすぎ → 下落しやすい

【RSI推移（直近n日）】

[get_indicators の本文から引用した数値を1行で]

↑/↓ [推移を見て1行で分析コメント（例: 一週間前に24台まで下落後、回復基調に転じています）]

※「⚠️ 今の状態:」は出力しない（上記の分析コメントで代替）

✅ 転換サイン:
[条件]

### 📊 MACD: [数値]（[プラス/マイナス]圏）

【プログレスバーの描画ルール】
※ 基準値: ±150,000（BTC/JPY日足の実態に合わせた基準）
※ 計算式: マス数 = min(10, abs(ヒストグラム値) ÷ 15,000)
※ │が0の位置（中央固定）
※ マイナス値: 0（│）から左へ伸ばす
※ プラス値: 0（│）から右へ伸ばす

マイナス例（-69,814 → 5マス）:
\`\`\`
░░░░░█████│░░░░░░░░░░ 下落圧力強
  ◀ 弱気   0   強気 ▶
\`\`\`

プラス例（+80,000 → 5マス）:
\`\`\`
░░░░░░░░░░│█████░░░░░ 上昇圧力強
  ◀ 弱気   0   強気 ▶
\`\`\`

【パターン一覧】
- 大きなマイナス(-150,000): ██████████│░░░░░░░░░░
- 中くらいマイナス(-70,000): ░░░░░█████│░░░░░░░░░░
- 小さなマイナス(-15,000):  ░░░░░░░░░█│░░░░░░░░░░
- ゼロ付近(-5,000):         ░░░░░░░░░░│░░░░░░░░░░
- 小さなプラス(+15,000):    ░░░░░░░░░░│█░░░░░░░░░
- 中くらいプラス(+80,000):  ░░░░░░░░░░│█████░░░░░
- 大きなプラス(+150,000):   ░░░░░░░░░░│██████████

**MACDとは**: トレンドの「勢い」と「転換点」を見る指標

**ヒストグラムの見方**

ヒストグラムは「MACD線 - シグナル線」の差を棒グラフ化したもの
- プラス → 上昇の勢い
- マイナス → 下落の勢い
- マイナス→プラス = ゴールデンクロス（上昇転換）
- プラス→マイナス = デッドクロス（下落転換）

**現在の状態**
- MACD線: [数値]
- シグナル線: [数値]
- ヒストグラム: [数値]（MACD - シグナル）
- 状態: [🔴デッドクロス継続中 / 🟢ゴールデンクロス継続中]

**直近の動き**
- ヒストグラム: 前日 [数値] → 今日 [数値]（[±差分] [改善/悪化]）
  → [マイナス幅が縮小中 = 下落の勢いが弱まる兆し / マイナス幅が拡大中 = 下落加速]

**転換サイン**
✅ ゴールデンクロス: MACD線がシグナル線を上抜け（ヒストグラムがゼロ通過）
→ ゴールデンクロスまであと約[数値]ポイント

## 📉 トレンド指標

### 📏 移動平均線（価格の平均ライン）

移動平均線とは: 過去X日間の平均価格をつないだ線
└ 現在の価格が線より上 = 上昇トレンド（強気の流れ）
  ※ただし平均から大きく離れていると調整で下がる可能性も
└ 現在の価格が線より下 = 下落トレンド（弱気の流れ）
  ※ただし平均から大きく離れていると反発で上がる可能性も

- 25日線:  XX,XXX,XXX円（現在価格から ±X.X%）
- 75日線:  XX,XXX,XXX円（現在価格から ±X.X%）
- 200日線: XX,XXX,XXX円（現在価格から ±X.X%）

配置: [例: 価格 < 25日 < 75日 < 200日]
→ [強気配列/弱気配列/混在]

### ☁️ 一目均衡表: [🔴三役逆転/🟢三役好転/🟡中立]

**一目とは**: 雲でトレンドを見る指標（雲の上=強気、下=弱気）

【一目均衡表の出力ルール】

1. 現在価格と雲の位置関係を判定
   - 価格 < 雲下端 → パターン1（雲の下）を使用
   - 雲下端 ≤ 価格 ≤ 雲上端 → パターン3（雲の中）を使用
   - 価格 > 雲上端 → パターン2（雲の上）を使用

2. 雲の囲みは二重線（╔═╗╚═╝║）を使用

**パターン1: 雲の下（弱気）**
\`\`\`
    ╔═══════════════════════╗
    ║ XX,XXX,XXX円  雲上端  ║
    ║                       ║
    ║   雲の厚さ X.X%       ║
    ║                       ║
    ║ XX,XXX,XXX円  雲下端  ║
    ╚═══════════════════════╝
         ↑ +X.X% 上方
 📍 XX,XXX,XXX円 ━━ 現在価格
\`\`\`

**パターン2: 雲の上（強気）**
\`\`\`
 📍 XX,XXX,XXX円 ━━ 現在価格
         ↓ -X.X% 下方
    ╔═══════════════════════╗
    ║ XX,XXX,XXX円  雲上端  ║
    ║                       ║
    ║   雲の厚さ X.X%       ║
    ║                       ║
    ║ XX,XXX,XXX円  雲下端  ║
    ╚═══════════════════════╝
\`\`\`

**パターン3: 雲の中（中立）**
\`\`\`
    ╔═══════════════════════════╗
    ║ XX,XXX,XXX円  雲上端      ║
    ║         ↑ +X.X%           ║
    ║                           ║
    ║ 📍 XX,XXX,XXX円 現在価格  ║
    ║    （雲の中で推移）       ║
    ║                           ║
    ║         ↓ -X.X%           ║
    ║ XX,XXX,XXX円  雲下端      ║
    ╚═══════════════════════════╝
\`\`\`

**三役の内訳**（3項目を箇条書き）
- 転換線 vs 基準線: XX,XXX,XXX円 [</>] XX,XXX,XXX円
- 価格 vs 雲: 雲の[上/中/下]で推移（±X.X%）
- 遅行スパン vs 価格: [上向き/下向き/横ばい]

→ [状況の意味を1行で補足。例: 雲が厚く上値抵抗が強い / 雲が下支えとして機能]

## 📐 ボラティリティ指標

### 📊 ボリンジャーバンド: [±Xσ位置]

ボリンジャーバンドとは: 価格が動く「通常の範囲」を帯で表示
└ ±2σ = 約95%の確率でこの範囲に収まる
└ バンド幅 = 広い→荒れ相場 / 狭い→静か

- +2σ: XX,XXX,XXX円（+X.X%）
- 中心: XX,XXX,XXX円
- -2σ: XX,XXX,XXX円（-X.X%）

現在位置: [±Xσ]
バンド幅: X.X%（[エクスパンション中/スクイーズ中]）

## 📍 重要な価格帯

【出力形式】コードブロックで縦の構造図を作成

\`\`\`
    XX,XXX,XXX円 ┄┄ [ライン名]（[説明]）+X.X%
         ↑
    XX,XXX,XXX円 ┄┄ [ライン名]（[説明]）+X.X%
         ↑
 📍 XX,XXX,XXX円 ┄┄ 現在価格 ←ココ
         ↓
    XX,XXX,XXX円 ┄┄ [ライン名]（[説明]）-X.X%
\`\`\`

※現在価格を中心に、上下それぞれ2-3本の重要ラインを配置
※各ラインには名称・意味・現在価格からの乖離率を記載

【必ず含めるライン】
- BB +2σ / -2σ（ボリンジャーバンド上下限）
- 雲上端 / 雲下端（一目均衡表の雲の範囲）
- 25日線 / 75日線 / 200日線（移動平均線）
※現在価格より上にあるものはレジスタンス、下にあるものはサポートとして配置

## ⚖️ 指標の総合判断

【見方が分かれる場合】
⚠️ **短期と中期で見方が分かれています**
- 🟡 **短期（勢い指標）**: [RSIやBBの数値と評価]
- 🔴 **中期（トレンド）**: [移動平均/一目の判定]
→ [矛盾の意味を1-2行で説明]

【見方が一致する場合】
✅ **主要指標の結論**: [方向性]
- 勢い: [要約]
- トレンド: [要約]

## 🎯 次の転換サイン

【反発シナリオの条件】
1. [条件1]: [価格や指標の具体値]
2. [条件2]: [価格や指標の具体値]
3. [条件3]: [価格や指標の具体値]

【下落継続シグナル】
- [条件1]
- [条件2]

## 💡 まとめ

[2-3行で結論]
- 現状の解釈
- 中期目線でのスタンス
- 最も注目すべきポイント

【出力例（勢い指標）】

### 🌡️ RSI（加熱度）: 34.33
███░░░░░░░ やや弱気

RSIとは: 0-100で「買われすぎ/売られすぎ」を測る指標
└ 30以下 = 売られすぎ → 反発しやすい
└ 70以上 = 買われすぎ → 下落しやすい

⚠️ 今の状態:
売られすぎ水準（30）に接近中
✅ 転換サイン:
RSIが30を割ってから反発、または40を回復

### 📊 MACD: -59,666（マイナス圏）
████████░░│░░░░░░░░░░ 下落圧力強
  ◀ 弱気   0   強気 ▶

MACDとは: トレンドの「勢い」と「転換点」を見る指標
└ ヒストグラム = 勢いの強さを棒グラフ化したもの

❌ 今の状態:
ヒストグラムが大きなマイナス。下落の勢いが継続中
✅ 転換サイン:
ヒストグラムの縮小（マイナス幅が減少）→ ゴールデンクロス

【プログレスバーの表記ルール】
RSI（0-100ベース、左から右へ）:
- 0-30:   ███░░░░░░░ 売られすぎ
- 30-50:  █████░░░░░ やや弱気
- 50:     █████████░ 中立
- 50-70:  ███████░░░ やや強気
- 70-100: ██████████ 買われすぎ

MACD（中央が0、左が弱気・右が強気）:
- 大きなマイナス: ████████░░│░░░░░░░░░░ 下落圧力強
- 小さなマイナス: ░░░░░███░░│░░░░░░░░░░ 下落圧力弱
- ゼロ付近:       ░░░░░░░░░█│█░░░░░░░░░ 中立
- 小さなプラス:   ░░░░░░░░░░│░░███░░░░░ 上昇圧力弱
- 大きなプラス:   ░░░░░░░░░░│░░░░░░████ 上昇圧力強

※ MACDは │ を中央（0）として、マイナスは左へ、プラスは右へ伸びる

【絵文字の使い分け】
- ✅ ポジティブ/転換サイン
- ⚠️ 注意/警戒
- ❌ ネガティブ
- 🟢 強気
- 🟡 中立/様子見
- 🔴 弱気

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。`
        }]
      }
    ],
    metadata: {
      level: PromptLevel.INTERMEDIATE,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '1分',
      tags: ['intermediate', 'indicators', 'comprehensive', 'rsi', 'macd', 'bb', 'ichimoku', 'sma']
    }
  },
  {
    name: '中級：BTCのフロー分析をして',
    description: '中級者向け：直近の売買フロー（CVD/aggressor ratio）からマーケットの方向性を分析',
    messages: [
      {
        role: 'assistant',
        content: [{
          type: 'text',
          text: `BTCのフロー分析をやって

【使用ツール】
1) get_flow_metrics (pair=btc_jpy, limit=300, bucketMs=60000, view=detailed)
2) get_transactions (pair=btc_jpy, limit=200, view=summary)  ※必要に応じて

【分析方針】
1. CVD（累積出来高差分）のトレンド
   - プラス → 買い優勢、マイナス → 売り優勢
   - 急激な変化（スパイク）は注目イベント

2. Aggressor Ratio（仕掛け側の割合）
   - 50%以上 → 買いが積極的
   - 50%以下 → 売りが積極的

3. Volume Spike（出来高急増）
   - zscore > 2.0 の時間帯を特定
   - 価格変動との相関を確認

4. 直近1-3時間の流れを重視
   - バケット単位（1分）のデータから短期モメンタムを判定

【出力フォーマット】

**【重要】タイムスタンプの記載**
- レポート冒頭には「📸 YYYY/MM/DD HH:MM:SS JST 時点」形式でデータ取得時刻を記載してください

---

- 結論：買い優勢/売り優勢/拮抗（1-2行）
- CVDの推移（グラフ的説明 or 数値）
- 注目すべきスパイク（あれば）
- 価格への影響予測

専門用語OK。数値には単位と意味を明記。

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。`
        }]
      }
    ],
    metadata: {
      level: PromptLevel.INTERMEDIATE,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '1分',
      tags: ['intermediate', 'flow', 'cvd', 'volume', 'transactions', 'short-term']
    }
  },
  {
    name: '中級：BTCの板の状況を詳しく見て',
    description: '中級者向け：板の厚み・流動性分布・大口注文から短期的なサポート/レジスタンスを分析',
    messages: [
      {
        role: 'assistant',
        content: [{
          type: 'text',
          text: `BTCの板の状況を詳しく見て

【使用ツール】
1) get_orderbook_statistics (pair=btc_jpy, ranges=[0.5,1,2], priceZones=10)
2) get_depth (pair=btc_jpy, view=sample, sampleN=20)  ※必要に応じて

【分析方針】
1. 流動性分布
   - ±0.5%/1%/2% の範囲での買い板・売り板の厚み
   - どの価格帯に注文が集中しているか

2. 大口注文の検出
   - 平均の2倍以上の注文（Bid/Ask）
   - 「壁」として機能する可能性のある価格帯

3. スプレッドとバランス
   - Bid/Ask のバランス（買い優勢/売り優勢）
   - スプレッドの広さ（流動性の評価）

4. 短期的なサポート/レジスタンス
   - 厚い買い板 → サポート（下がりにくい）
   - 厚い売り板 → レジスタンス（上がりにくい）

【出力フォーマット】

**【重要】タイムスタンプの記載**
- レポート冒頭には、取得したデータのタイムスタンプ（📸で始まる行）に「時点」を付けて記載してください（例：📸 2025/11/24 23:03:45 JST 時点）
- 板情報は秒単位で変動するため、「いつ時点のスナップショットか」を明示することが重要です
- 各ツールの出力に含まれるタイムスタンプをそのまま使用し、末尾に「時点」を追加してください

---

- 結論：買い圧力/売り圧力/拮抗（1-2行）
- 重要な価格帯（サポート/レジスタンス）
- 大口注文の位置（あれば）
- 短期トレードへの示唆

専門用語OK。価格帯は具体的な数値で明示。

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。`
        }]
      }
    ],
    metadata: {
      level: PromptLevel.INTERMEDIATE,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '1分',
      tags: ['intermediate', 'orderbook', 'depth', 'liquidity', 'support', 'resistance', 'short-term']
    }
  },
  {
    name: '中級：BTCのパターン分析をして',
    description: '中級者向け：短期（2本足）から中長期（大型パターン）まで、複数の時間軸でパターンを検出し、現在価格への影響を評価',
    messages: [
      {
        role: 'assistant',
        content: [{
          type: 'text',
          text: `BTCの包括的チャートパターン分析をして

【目的】
短期（2本足）から中長期（大型パターン）まで、複数の時間軸でパターンを検出し、現在価格への影響を評価する

【最重要ルール】
**完成後80日以上経過したパターンは、回答のどこにも記載しない（存在しないものとして扱う）**

【出力の構成（重要度順）】
1. 形成中チャートパターン（大型、現在進行形、切迫性順）
2. 完成済みチャートパターン（大型、影響度順、**完成後79日以内のみ**）+ 過去パターンの位置づけ
3. 短期ローソク足パターン（2本足、直近5日間）
4. 重要パターンの解釈（短期 vs 中長期の整合性）
5. 今後のシナリオ（強気📈/弱気📉/中立⏸️）
6. 現在の市場状況（1段落の要約）

※**絶対厳守**: 完成後80日以上経過したパターンは、全てのセクションで一切言及しない。

【出力ポリシー】
- **中間処理の非表示（最優先）**: ツール実行後の内部計算・整理プロセスは一切出力しない
  - 「〜を計算します」「〜を整理します」「データを確認します」などの作業宣言は禁止
  - 「全てのデータが揃いました」「経過日数を計算して〜」などの中間説明も禁止
  - 最終的にフォーマット済みの出力のみを表示すること
  - ツール結果の受信から最終出力まで、思考過程や中間ステップは完全に内部処理として扱う

- **鮮度フィルタリング（最重要）**: 完成後80日以上経過したパターンは**完全に無視**
  - 回答のどこにも記載しない（本文、統計情報、まとめ、すべてのセクションで言及禁止）
  - 「除外しました」「フィルタリングしました」などの説明も不要
  - 検出されても存在しないものとして扱う

- **影響度判定（最優先ルール）**: 近接性チェックを必ず最初に実施
  - ネックライン/ターゲットから10%以上離れている → **自動的に低⚪**
  - 「中🟡」に記載されるのは、近接性がある（±10%以内）パターンのみ

- **重複排除（厳格）**: 同じデータを複数箇所で記載しない

- 簡潔化: 構造的特徴の統計データ（傾き、タッチ回数、適合度r²、収束率など）は出力しない。

【分析手順（ツールは2つ、出力順に合わせて実行）】
1) detect_patterns（形成中+完成済みの大型パターン、統合版）
   - pair: btc_jpy
   - type: 1day
   - limit: 180
   - patterns: ["double_top", "double_bottom", "triple_top", "triple_bottom", 
                "head_and_shoulders", "inverse_head_and_shoulders",
                "triangle_ascending", "triangle_descending", "triangle_symmetrical",
                "falling_wedge", "rising_wedge", "pennant", "flag"]
   - view: detailed
   - includeForming: true     // 形成中パターンも含める
   - includeCompleted: true   // 完成済みパターンも含める
   - requireCurrentInPattern: true  // 重要: 鮮度フィルタを有効化
   - currentRelevanceDays: 80  // 80日以内のパターンのみ表示（80日以上は完全除外）
   
   **重要**: 
   - status="forming" または "near_completion" → 形成中セクションに表示
   - status="completed" → 完成済みセクションに表示
   - ウェッジの breakoutDirection/outcome を確認して成功/失敗を判定

2) analyze_candle_patterns（短期2本足パターン）
   - pair: btc_jpy
   - type: 1day
   - allow_partial_patterns: false（確定パターンのみ）
   → パターンがあれば render_candle_pattern_diagram でSVG生成

4) 影響度評価（各完成済みパターンについて）
   
   **最優先ルール: 近接性チェック**
   - ネックライン/ターゲットから10%以上離れている → **自動的に低⚪**（他の要素に関わらず）
   - 例: ダブルボトム（ネックラインから-24%離れている、理論ターゲット達成済み） → 低⚪
   
   **近接性がある場合のみ、以下の4要素で詳細評価:**
   
   a) 鮮度: 完成からの経過日数（30日以内=高、80日以上=完全除外）
   
   b) 近接性: 現在価格との距離
      - 原則: ネックラインから±10%以内=高評価
      - 特例: 理論ターゲット到達中（80%以上）の場合、ターゲットとの距離も考慮
      - **10%超=自動的に低⚪（他の要素の評価不要）**
   
   c) 整合度: パターンの統計的精度（0.00 ~ 1.00）
   
   d) 構造的重要性: パターン間の相互関係
      - 後続の逆方向パターンで打ち消し
      - 理論ターゲット達成済み
      - 完成後50日以上経過で減衰（ただし80日以上は除外）

【影響度判定基準（最優先ルール）】

**ステップ1: 近接性チェック（必ず最初に確認）**
- ネックライン/ターゲットから10%以上離れている → **自動的に低⚪**（例外なし）
  - 例: ネックラインから-24%離れている → 低⚪確定
  - 例: ネックラインから+30%離れている → 低⚪確定
  - ※理論ターゲット達成済み、打ち消し済みなどの理由に関わらず、10%以上離れていれば低⚪

**ステップ2: 近接性がある場合のみ、以下で判定**
- **高 🔴**: ネックライン/ターゲット（到達中80%以上の場合）が現在価格の±10%以内、かつ総合評価が高い
- **中 🟡**: ネックライン/ターゲットが現在価格の±10%以内、かつ総合評価が中程度
  - ※近接性がない（10%以上離れている）場合は、絶対に中🟡にならない
- **低 ⚪**: 近接性はあるが、総合評価が低い、または後続パターンに打ち消され済み

**特例: 理論ターゲット到達中（80%以上）の場合**
- ネックラインが遠くても、ターゲットが±10%以内なら高評価
- 例: 三尊（ネックライン-18%、ターゲット+3.8%で到達96%）→ 高🔴
- ただし、ターゲットも10%以上離れていれば → 低⚪

【フィルタリングルール（厳格に適用）】
- **完成後80日以上経過: 完全に除外**（検出されても出力しない、古すぎる情報のノイズ削減）
  ※ **重要**: 80日以上経過したパターンは、回答のどこにも記載しないこと。
  　「除外」「フィルタリング」などの説明も不要。存在しないものとして扱う。

- 完成後80日未満で近接性0点（10%以上離れている）: **自動的に低⚪** → 「過去パターンの位置づけ」に簡潔に記載
  - ※理論ターゲット達成済み、打ち消し済みなどの理由に関わらず、10%以上離れていれば低⚪

- 例（回答での扱い方）:
  - ダブルトップ（完成後88日） → **回答のどこにも記載しない（完全に無視）**
  - ダブルトップ（完成後288日） → **回答のどこにも記載しない（完全に無視）**
  - 逆三尊（完成後56日、ネックラインから+31%離れている） → **低⚪**「過去パターンの位置づけ」に簡潔に記載 ✓
  - ダブルボトム（完成後50日、ネックラインから-24%離れている、理論ターゲット達成済み） → **低⚪**「過去パターンの位置づけ」に簡潔に記載 ✓

【出力フォーマット】
※重要度順の流れ: 形成中→完成済み→短期→解釈→シナリオ→要約
※構造的特徴の統計データ（傾き、タッチ回数、適合度r²、収束率など）は出力しない（中級者にとって過剰）

**【重要】出力開始ルール:**
- 回答は「## 1. 形成中チャートパターン」セクションから直接開始すること
- その前に中間処理の説明（「データを整理します」「計算を行います」等）を一切出力しない
- ツール結果の受信・計算・整理は全て内部処理として完了させ、最終出力のみを表示

---

## 1. 形成中チャートパターン

※形成中のパターンのみを切迫性順に記載（無効化済みパターンは除外）
※**重要**: 形成中パターンがない場合は「ℹ️ 現在、形成中のチャートパターンは検出されていません。」とだけ記載し、完成済みパターンへの言及は一切しないこと。

### ℹ️ パターンなしの場合
ℹ️ 現在、形成中のチャートパターンは検出されていません。

（↑形成中がない場合はこの1行のみ。完成済みパターンには言及しない）

### 🔴🔴🔴 極めて高い切迫性（アペックス到達/ブレイク目前）
- **パターン名**（方向性）: （例: フォーリングウェッジ・弱気継続から強気反転を示唆）
- **形成状況**: アペックス到達（YYYY-MM-DD）、完成度XX%
- **重要水準**:
  - 上限ブレイク: XX,XXX,XXX円（現在価格から+X%） → 強気転換
  - 下限ブレイク: XX,XXX,XXX円（現在価格から-X%） → 弱気継続
- **想定ターゲット**:
  - 上方ブレイク時: XX,XXX,XXX円
  - 下方ブレイク時: XX,XXX,XXX円
- **失効条件**: XX,XXX,XXX円を明確に超える/割る

※注意: ウェッジ系パターンの場合、上側ライン・下側ラインの傾き、タッチ回数、適合度r²、収束率などの統計データは記載しない。重要水準（ブレイクレベル）のみ記載。

### 🔴🔴 高い切迫性（数日以内）
（同様のフォーマット、該当があれば記載）

---

## 2. 完成済みチャートパターン（現在も影響力あり）
※完成後80日以上経過したパターンは一切記載しない（検出されても無視）

### 🔴 高影響度（現在価格の±10%以内）

#### 1. パターン名（例: 三尊（ヘッドアンドショルダー））

- **パターン名**: 三尊（弱気転換パターン）/ 逆三尊（強気転換パターン）
- **期間**: YYYY-MM-DD ~ YYYY-MM-DD（完成後X日）
- **整合度**: X.XX（高いほど典型的、0.95以上は極めて典型的）
- **構造**:
  - 三尊系（縦並び）:
    - 左肩: XX,XXX,XXX円（M/D）
    - 頭: XX,XXX,XXX円（M/D）
    - 右肩: XX,XXX,XXX円（M/D）
    - ネックライン: XX,XXX,XXX円（傾斜型: XX,XXX,XXX円 → XX,XXX,XXX円）
  - ダブル系（縦並び）:
    - 第1谷/山: XX,XXX,XXX円（M/D）
    - 第2谷/山: XX,XXX,XXX円（M/D）
    - ネックライン: XX,XXX,XXX円
  - ウェッジ系: ブレイクアウトレベル（XX,XXX,XXX円）のみ記載
    - ※傾き、タッチ回数、適合度r²、収束率などの統計データは記載しない
- **ブレイクアウト**: YYYY-MM-DD、下方/上方ブレイク、価格変動 ±X%
- **理論ターゲット**: XX,XXX,XXX円（到達度X%、現在価格から±X%）
- **判定理由**: 理論ターゲットまで残り±X%と近接、トレンドの終点として現在の価格形成に直接的な影響。現在価格XX,XXX,XXX円は理論ターゲットを既に下回っており/到達中、パターンの想定範囲をほぼ達成。

### 🟡 中影響度（現在価格の±10%以内、総合評価は中程度）
※ネックライン/ターゲットから10%以上離れているパターンは、ここには記載されません（自動的に低⚪）

（該当があれば簡潔に記載、該当なしの場合はこのセクション自体を省略）

### 過去パターンの位置づけ（低影響度⚪、簡潔に）
※**完成後80日未満**で、近接性0点（10%以上離れている）パターンのみ記載
※**完成後80日以上経過したパターンは一切記載しない（言及不要）**
※**重要**: ネックライン/ターゲットから10%以上離れているパターンは、理由に関わらず全てここに記載
※**並び順**: 完成後の経過日数が短い順（新しいパターンを先に表示）

- **フォーリングウェッジ**（M/D-M/D、完成後X日）: 下方ブレイク（パターン失敗） → 影響度: 低
- **ダブルボトム**（M/D-M/D、完成後X日）: ネックラインから±X%離れており、理論ターゲット達成済み → 影響度: 低
- **逆三尊**（M/D-M/D、完成後X日）: ネックラインから±X%離れており、三尊に打ち消され済み → 影響度: 低
- **ダブルボトム**（M/D-M/D、完成後X日）: ネックラインXX,XXX,XXX円から±X%離れており、理論ターゲット達成済み、三尊に打ち消され済み → 影響度: 低
  - 例: ダブルボトム（9/1-10/2、完成後50日）: ネックライン17,351,076円から-24%離れており、理論ターゲット達成済みで三尊に打ち消され済み → 影響度: 低


---

## 3. 短期ローソク足パターン（2本足）

※パターンがある場合:

### ✅ [パターン名]（強度XX%）

- **確定日**: [日付]
- **方向性**: 強気/弱気
- **過去実績**:
  - 1日後: 勝率XX% (X勝X敗)、平均リターン XX%
  - 3日後: 勝率XX% (X勝X敗)、平均リターン XX%
  - 5日後: 勝率XX% (X勝X敗)、平均リターン XX%

[SVG図を表示: render_candle_pattern_diagram を呼び出し]

**短期的な見方**: このパターンは[1〜2日以内の短期的な動き]を示唆します。

---

※パターンなしの場合:

### ℹ️ 短期サインなし

直近5日間では、特徴的な2本足パターンは検出されませんでした。

---

## 4. 重要パターンの解釈

### 時間軸別の分析

- **短期（1-3日）**: [2本足パターンの示唆、またはサインなしの場合は「明確な短期シグナルなし」]
- **中期（1-2週間）**: [形成中チャートパターンの影響、切迫性と方向性]
- **長期（1-3ヶ月）**: [完成済みチャートパターンのトレンド、ターゲット到達状況]

### 整合性チェック

短期と中長期のシグナルが[一致/矛盾]しています。

[具体的な解釈2〜3行]
- 一致の場合: 複数時間軸で同じ方向を示唆 → 信頼性が高い
- 矛盾の場合: 短期は上昇示唆だが中長期は下落継続 → 短期的な反発に注意

### 今後数日の注目点
1. **形成中チャートパターンのブレイク**: [形成中パターンのブレイク方向]
2. **完成済みパターンの重要ライン**: [ターゲット/ネックライン]
3. **短期ローソク足パターンの実現**: [2本足パターンの方向に動くかどうか]

---

## 5. 今後のシナリオ

### 強気シナリオ 📈
- **トリガー**: XX,XXX,XXX円突破（フォーリングウェッジの上限ブレイク）
- **想定ターゲット**: XX,XXX,XXX円（+X%）
- **根拠**: 
  - フォーリングウェッジの上方ブレイク（強気反転シグナル）
  - 三尊の理論ターゲット到達による下落トレンド終了
  - XX,XXX,XXX円を明確に超えれば上昇トレンド転換
- **確率**: 中（〇〇の条件次第）

### 弱気シナリオ 📉
- **トリガー**: XX,XXX,XXX円割れ（三尊の理論ターゲット下抜け、またはフォーリングウェッジの下限ブレイク）
- **想定ターゲット**: XX,XXX,XXX円（-X%）
- **根拠**:
  - 三尊の理論ターゲット（XX,XXX,XXX円）を明確に割ると下落加速
  - フォーリングウェッジの下方ブレイクで弱気継続
  - サポートゾーン喪失による心理的売り圧力
- **確率**: 高（現在のモメンタム継続の場合）

### 中立/様子見シナリオ ⏸️
- **条件**: XX,XXX,XXX円 ~ XX,XXX,XXX円のレンジ内で推移
- **監視ポイント**: 
  - フォーリングウェッジのブレイク方向
  - 三尊の理論ターゲット（XX,XXX,XXX円）でのサポート機能
  - 出来高の変化（急増時はブレイクアウトの兆候）

---

## 6. 現在の市場状況（要約）

BTC/JPYは現在、[短期/中期/長期の状況を1段落で要約]。

【検出パターン】
- 形成中チャートパターン: X個（切迫性: 極高X個、高X個）
- 完成済みチャートパターン: X個（高影響度X個、中影響度X個）
  ※完成後80日以上経過したパターンは除外済み
- 短期ローソク足パターン（2本足）: [パターン名]または「なし」

【視覚化】
- チャートパターン（大型）: ユーザーが明示的に希望した場合のみ render_chart_svg を使用
- ローソク足パターン（2本足）: 自動的にSVG図を表示

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。`
        }]
      }
    ],
    metadata: {
      level: PromptLevel.INTERMEDIATE,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '2分',
      tags: ['intermediate', 'patterns', 'comprehensive', 'chart-patterns', 'forming', 'completed', 'structure']
    }
  },
  {
    name: '中級：BTCのサポレジを分析して',
    description: '中級者向け：過去の反応×板の厚み×直近の攻防から、価格帯の強弱を統合的に分析',
    messages: [
      {
        role: 'assistant',
        content: [{
          type: 'text',
          text: `BTCのサポート・レジスタンスを分析して

【分析ポリシー】
- チャートは出さない（数値・テキストのみ）
- 過去90日のローソク足から反発/反落の密度を計算
- 現在の板の厚みと照合し、整合性を評価
- 上下各2-3本の重要ラインに絞る
- 「強い/弱い」の根拠を必ず数値で示す
- **ツール実行後は直ちに最終出力へ移行、中間結果の説明は不要**

【使用ツール（この順）】

### 必須ツール
1. **analyze_support_resistance** (pair=btc_jpy, lookbackDays=90, topN=3)
   - 目的: 過去90日のサポート・レジスタンスを自動検出（サーバー側で正確に計算）
   - 出力: 各レベルの価格・強度（★1-3）・接触回数・接触日時・直近崩壊情報
   - 重要: このツールの出力（content）をそのまま使用。独自計算は不要

2. **get_depth** (pair=btc_jpy, view=sample, sampleN=30)
   - 目的: 現在の板の詳細分布を取得

3. **get_orderbook_pressure** (pair=btc_jpy, bandsPct=[0.005, 0.01, 0.02], weightScheme=byDistance)
   - 目的: ±0.5%/1%/2%の各帯域での買い/売り圧力を定量化

### 任意ツール（必要に応じて）
4. **analyze_sma_snapshot** (pair=btc_jpy, type=1day, periods=[25, 75, 200])
   - 目的: 移動平均線が心理的サポレジとして機能しているか確認

【分析手順】

### Step 1: サポート・レジスタンスツールの結果を解釈

**やること**:
1. \`analyze_support_resistance\` の出力（content）を確認
   - 各レベルの価格・距離（%）・強度（★）
   - **形成タイプ（従来型/新形成/転換型）** ← 重要
   - 接触回数と接触日時
   - 出来高ブースト情報
   - 補足説明（note）

2. 重要な注意事項:
   - ツールが出力した全ての情報をそのまま使用
   - 独自に日付を推測したり、接触回数を数え直したりしない
   - 形成タイプに応じて評価を変える：
     - **従来型**: 過去90日の反応実績ベース、最も信頼性高い
     - **新形成**: 安値切り上げによる新サポート、出来高で強度判定
     - **転換型（ロールリバーサル）**: 崩壊したサポート→レジスタンス転換、検証待ちで強度★

3. **判定ロジックの理解**:
   - ツールは3種類のサポート/レジスタンスを検出
   - A. 従来型：直近7日で崩壊していない、2回以上の反応実績
   - B. 新形成：安値2日以上切り上げ + 以降割れなし
   - C. 転換型：崩壊したサポート→レジスタンス、突破したレジスタンス→サポート
   - 有効なレベルが少ない場合でも、無理に枠を埋めない

### Step 2: 現在の板情報と照合

**やること**:
1. \`get_depth\`の結果から、Step 1で検出された価格帯に大口注文が集中しているか確認
2. \`get_orderbook_pressure\`で各帯域の買い/売り優勢度を取得
3. 整合性を評価:
   - ✅ ツール検出レベル + 現在の板厚い = 信頼性高い
   - ⚠️ ツール検出レベル + 現在の板薄い = 機能しないリスク
   - ❌ ツール未検出 + 現在の板だけ厚い = 単なる一時的な壁

**【板情報の活用（重要）】**

\`get_depth\` と \`get_orderbook_pressure\` で取得したデータを活用してください。ただし、bitbank APIの仕様上、通常±5-6%程度までの板しか存在しないことを理解した上で分析してください。

1. **第1サポート/レジスタンス（現在価格±3%以内）**
   - ±0.5%/±1%/±2%の板厚から直接評価
   - 具体的な数値（X BTC）を必ず記載
   - 例：「13,600,000円±0.5%に買い注文10.5 BTC」

2. **第2サポート/レジスタンス（現在価格から3-5%程度）**
   - \`get_depth\` の範囲内であれば、該当価格帯の板を集計して記載
   - 範囲外の場合：「取得範囲外（bitbank板は通常±5%程度まで）のため板情報なし」
   - この場合、過去の反応頻度と強度のみで評価

3. **第3サポート/レジスタンス（現在価格から7%以上離れている）**
   - ほぼ確実に取得範囲外
   - ✅ 「現在価格から±X%離れており、取得範囲外のため板情報なし」と明記
   - ✅ **過去90日の反応回数・反発/反落の強度・出来高**を主要指標として評価
   - ✅ これらの実績データのみで★★★（強固）や★★（中程度）を判定することは正当

**【重要な注意】**
- 範囲外は事実なので、正直に記載することは正しい対応
- 「推測」「不明」などの曖昧表現は禁止
- 範囲外でも、過去の反応実績が豊富なら強度★★★を付けることは適切

### Step 3: 強度の最終評価と板情報の統合

**やること**:
1. \`analyze_support_resistance\` が既に強度（★1-3）を計算済み
   - この強度は過去の反応頻度・直近の維持状況・崩壊実績を総合評価したもの
   - そのまま使用すること

2. 板情報による補足評価:
   - 範囲内（±5%程度）のレベル：板の厚みを追加評価材料として記載
   - 範囲外のレベル：「取得範囲外のため板情報なし」と明記

3. 最終的な強度表現:
   - ツールの★をそのまま使用
   - 板情報は「補足情報」として記載（強度の上書きはしない）

### Step 4: 直近7日の攻防確認

**やること**:
- 最重要サポート/レジスタンスが過去7日で何回試されたか
- 試された際のヒゲの長さ（反発/反落の勢い）
- 連続して試されている場合は「疲弊リスク」を警告

**【直近の攻防状況の記載ルール（最重要）】**

過去7-10日間のローソク足データから、サポート/レジスタンスの防衛状況を正確に判定してください。
特定の表現が含む暗黙のニュアンスに注意し、事実と異なる印象を与えないようにします。

**1. 使用禁止表現とそのニュアンス**

以下の表現は「まだ破られていない」という暗黙のニュアンスを含むため、一度でも割り込んだ場合は使用禁止です：
- 「試され」「試され防衛」→ まだ破られていない印象（一度も割り込んでいない場合のみ使用可能）
- 「防衛」「防衛中」→ 守り切っている印象（一度も割り込んでいない場合のみ使用可能）
- 「疲弊」「疲弊中」「疲弊リスク」→ 弱っているが耐えている印象（一度も割り込んでいない場合のみ使用可能）

**2. 「防衛」「試され」の厳密な定義**

使用可能な条件（厳格）：
- サポートの場合：過去7-10日間の安値が該当価格を一度も下回っていない
- レジスタンスの場合：過去7-10日間の高値が該当価格を一度も上回っていない

判定手順：
1. 過去7-10日分のローソク足データを確認
2. 各日の安値（サポート）または高値（レジスタンス）をチェック
3. 一度でも該当価格を超えていたら → 使用禁止

**3. 一度でも割り込んだ場合の正しい表現**

❌ 避けるべき表現：「過去5日で3回試され」「連続攻撃で疲弊中」「X回試され防衛しているが疲弊リスク」

✅ 正しい表現：
- 「X月X日に崩壊（最安/最高〇〇円、±X.X%）したが、X月X日に回復」
- 「一度破られた実績があり、信頼性が低下」
- 「崩壊から回復したが、再接触中でリスク高」
- 「過去5日で4回接触、うち1回崩壊（11/21、-7.2%）、3回防衛」
- 「脆弱性が露呈」「再割れリスク高」

**4. 実例による比較**

❌ 悪い例（実際に割り込んでいる場合）：「過去7日で3回試され現在4回目接触中→疲弊リスク高」
【問題点】「試され」→まだ破られていない印象、実際には11/21に-7.2%崩壊している事実が隠れる

✅ 良い例：「11/20に接触し防衛、11/21に崩壊（最安12,664,060円、-7.2%）、11/23-24で回復後、本日再接触中 ⚠️ 崩壊実績により信頼性低下、再割れリスク高」

✅ 「試され」「疲弊」を使える例（一度も割り込んでいない場合）：「過去5日で5回接触、いずれも防衛（安値13,620,000円で反発）⚠️ 5回連続防衛しているが疲弊の兆候、次回で崩れる可能性」

**5. 強度評価への反映**

直近7日以内に崩壊した価格帯：
- 過去90日の実績だけで判断せず、直近の崩壊実績を反映
- 強度を-1レベル減格、減格理由を明記
- 例：「過去90日で5回反発（本来★★★相当）だが、直近11/21に崩壊。崩壊実績により★★★から★★に減格」

**6. セクション間の整合性チェック（必須）**

出力前に以下を確認：
- チェック1: セクション1で「試され」「防衛」「疲弊」使用 → 該当期間で一度も割り込んでいないか再確認
- チェック2: セクション1で「試され」記載 → セクション2/3の「現状」で「崩壊」と矛盾していないか
- チェック3: セクション1で「防衛中」記載 → セクション5「注意点」で「崩壊実績あり」と矛盾していないか
- チェック4: 直近7日で崩壊した価格帯に★★★を付けていないか、減格理由が明記されているか

**表現の使い分けガイド**
- 中立的な表現（常に使用可能）：「接触」「再接触」「到達」「X回接触、うちY回崩壊、Z回防衛」
- 割り込んでいない場合：「防衛」「試され」「疲弊」「疲弊リスク」「次回で崩れる可能性」
- 割り込んだ場合：「崩壊」「破られた」「割り込み」「脆弱性」「信頼性低下」「再割れリスク」「再崩壊リスク」

【出力フォーマット】

**【重要】出力ルール（厳守）**
- **出力は必ず「📌 分析範囲について」から開始すること**
- 冒頭にデータ確認の経緯や中間結果を記載しない
- ツール呼び出しの結果説明も不要
- 以下のフォーマットに従い、追加の前置きや説明を挿入しないこと

---

**📌 分析範囲について**

本分析の板情報は、bitbank APIの仕様により現在価格から±5%程度の範囲で取得しています。
それより離れた価格帯は、過去の反応実績のみで評価しています。

---

## 1. 現在の状況（要約）

📍 **現在価格**: XX,XXX,XXX円

⚠️ **最重要ポイント**:
- [最も注意すべき状況を1行で（例: 第1サポート13,400,000円が3回目の試し→崩れるリスク高）]
- [板の買い/売りバランス（例: 売り圧力がやや優勢 買い6.9 vs 売り7.4 BTC）]
- [トレンドの方向性（例: 全てのSMAを大きく下回り、強い下落トレンド継続中）]

---

## 2. サポートライン（下値の支え）

**【重要】出力基準（厳守）**
- \`analyze_support_resistance\` で検出されたレベルのみ出力
- 有効なサポートがない場合は「明確なサポートラインは検出されませんでした」と記載
- 無理に枠を埋めない（1本でも2本でも、検出された数だけ出力）
- タイプ名（「新形成」「転換」等）は表示しない、平易な説明のみ

### 🟢 サポート: **XX,XXX,XXX円**（-X.X%）強度：★★★
- **背景**: [どうしてサポートになるのか平易に説明（例: 過去90日で5回反発、最終11/23。実績豊富で信頼性高い）]
- **板の状況**: [買い注文量と評価（例: 買い注文5.7 BTC、標準的な厚さ）]
- **意義**: [1行で（例: 割れると次のサポートまで-3%の空白地帯）]

### 🟢 サポート: **XX,XXX,XXX円**（-X.X%）強度：★★☆
- **背景**: [平易な説明（例: 11/21の急落で底を打ち、3日連続で安値切り上げ中。大出来高での反発）]
- **板の状況**: [買い注文量（範囲内の場合）]
- **意義**: [1行で（例: 直近の最安値、最終防衛ライン）]

### 🟢 サポート: **XX,XXX,XXX円**（-X.X%）強度：★☆☆
- **背景**: [平易な説明（例: 10/26に上抜けした価格帯。現在は「上抜け後の下支え」として機能する可能性）]
- **板の状況**: [買い注文量（範囲内の場合）]
- **注意**: [1行で（例: 11/21に一度崩壊済み、再割れリスク高）]

※ 検出された数だけ出力。「なぜサポートになりうるか」を平易に説明。

---

## 3. レジスタンスライン（上値の壁）

**【重要】出力基準（厳守）**
- \`analyze_support_resistance\` で検出されたレベルのみ出力
- 有効なレジスタンスがない場合は「明確なレジスタンスラインは検出されませんでした」と記載
- 無理に枠を埋めない（1本でも2本でも、検出された数だけ出力）
- タイプ名（「転換」等）は表示しない、平易な説明のみ

### 🔴 レジスタンス: **XX,XXX,XXX円**（+X.X%）強度：★★☆
- **背景**: [どうしてレジスタンスになるのか平易に説明（例: 過去90日で8回反落、最終11/15。実績豊富で信頼性高い）]
- **板の状況**: [売り注文量と評価（例: 売り注文2.3 BTC、平均の0.3倍→板が薄く突破しやすい）]
- **意義**: [1行で（例: 突破しても25日線15,334,347円（+14.3%）が次の強力な壁）]

### 🔴 レジスタンス: **XX,XXX,XXX円**（+X.X%）強度：★☆☆
- **背景**: [平易な説明（例: 11/21に崩壊した元サポート。現在は「戻り売りポイント」として機能する可能性）]
- **板の状況**: [売り注文量（範囲内の場合）]
- **注意**: [1行で（例: 転換直後で信頼性未確認、突破される可能性もあり）]

※ 検出された数だけ出力。「なぜレジスタンスになりうるか」を平易に説明。

---

## 4. シナリオ（3パターン）

### 📉 **下抜けシナリオ**（確率: 高/中/低）
- **トリガー**: XX,XXX,XXX円を終値で割る
- **ターゲット**: XX,XXX,XXX円（-X.X%）、最悪XX,XXX,XXX円（-X.X%）
- **根拠**: 
  - [理由1（例: 3回目の試しで疲弊）]
  - [理由2（例: 板の売り圧力優勢）]
  - [理由3（例: 強い下落トレンド継続中）]

### 📈 **上抜けシナリオ**（確率: 高/中/低）
- **トリガー**: XX,XXX,XXX円を出来高XXX BTC以上で突破
- **ターゲット**: XX,XXX,XXX円（+X.X%）
- **障壁**: [次の抵抗（例: 25日線15,334,347円（+14.3%））]

### ⏸️ **レンジ継続**（確率: 高/中/低）
- **条件**: XX,XXX,XXX円～XX,XXX,XXX円（幅X.X%）
- **監視**: 
  - [監視点1（例: 13,400,000円の4回目の試し）]
  - [監視点2（例: 出来高が400BTC超で急増）]
  - [監視点3（例: 板の買い注文の増減）]

---

## 5. 注意点

⚠️ **[カテゴリ1（例: 最重要リスク）]**: [具体的なリスクを1行で（例: 13,400,000円割れ→13,000,000円まで空白地帯-3%急落）]

⚠️ **[カテゴリ2（例: 疲弊の兆候）]**: [具体的なリスクを1行で（例: 3回連続試されており、本日の防衛が失敗する可能性）]

⚠️ **[カテゴリ3（例: 上値の重さ）]**: [具体的なリスクを1行で（例: 25日線+14.3%まで明確な買いシグナルなし）]

---

## 6. 構造図（視覚的サマリー）

セクション2・3で分析したサポート・レジスタンスを、以下のテキスト形式で視覚化してください。

**フォーマット:**

\`\`\`
構造図（テキスト版）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 XX,XXX,XXX円 ★★★ 第3レジスタンス (+XX.X%)
│
│        [注記がある場合はここに記載]
│
🔴 XX,XXX,XXX円 ★★ 第2レジスタンス (+XX.X%)
│
│        [注記]
│
🔴 XX,XXX,XXX円 ★★★ 第1レジスタンス (+XX.X%)
│
│        [注記]
│
├─────────────────────────────
📍 XX,XXX,XXX円 ← 現在価格
├─────────────────────────────
│
│
🟢 XX,XXX,XXX円 ★★★ 第1サポート (-XX.X%)
│
│        [注記] ⚠️ [リスクがある場合]
│
│  -X.X% 空白地帯
│
🟢 XX,XXX,XXX円 ★★ 第2サポート (-XX.X%)
│
│        [注記]
│
│
│
🟢 XX,XXX,XXX円 ★★★ 第3サポート (-XX.X%)
│
│        [注記]
│        板: 取得範囲外（±5-6%超）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【現在の市場構造】
- トレンド: [強い下落/横ばい/上昇等]
- 板の圧力: [買いやや優勢/売り優勢等] (+X.XX だが絶対量は中程度)
- 最重要ライン: XX,XXX,XXX円（第1サポート）
- リスク: [最も注意すべきリスクを1行で]
\`\`\`

**作成ルール:**

1. **縦軸配置**: 上から下へ（高値→現在価格→安値）の順
2. **絵文字**: 🔴レジスタンス、📍現在価格、🟢サポート
3. **強度**: ★の数（1-3個）でそのまま表示
4. **距離**: 各ラインの横に (+X.X%) または (-X.X%) を明記
5. **空白地帯**: サポート間の距離が2%以上ある場合は「-X.X% 空白地帯」と警告
6. **注記**: 各ラインの最も重要な情報を15文字以内で（例: "本日試し中"、"11/21-22に防衛"）
7. **リスク警告**: 疲弊リスクや急落リスクがある場合は ⚠️ を付ける
8. **市場構造サマリー**: 最後に4項目で現状をまとめる

**注記の選定基準:**
- 第1サポート/レジスタンス: 「現状」から選ぶ（試されている状況・距離）
- 第2・第3: 「根拠」または「意義」から最も特徴的なものを選ぶ

**板情報記載の良い例:**

🟢 第2サポート: 13,300,000円（-2.4%）強度：★★★
│
│        11/21-22に2回連続防衛
│        板: 13,265,000-13,335,000円に買い7.2 BTC（±1%で13.8 BTC、厚め）

🔴 第1レジスタンス: 14,000,000円（+2.7%）強度：★★☆
│
│        8回反落、心理的節目
│        板: 13,930,000-14,070,000円に売り4.6 BTC（やや薄め、突破可能性あり）

**板情報記載の悪い例（禁止）:**

❌ 🟢 第2サポート: 13,300,000円（-2.4%）強度：★★★
│
│        現在価格から遠く、板情報は限定的だが過去の反発実績が豊富

❌ 🔴 第2レジスタンス: 14,500,000円（+6.4%）強度：★★★
│
│        売り板の詳細は不明だが過去の実績から強固と推測

**範囲外の場合の良い例:**

✅ 🟢 第3サポート: 12,600,000円（-7.6%）強度：★★★
│
│        過去90日で5回反発、うち3回は下ヒゲ2.5%以上
│        板: 現在価格から-7.6%離れており取得範囲外（bitbank板は通常±5%程度まで）
│        過去の反発実績から強度★★★と評価

【表現ルール】

### 数値表記
- 価格: カンマ区切り（14,520,000円）
- パーセント: 小数点1桁まで（+2.3%）
- BTC数量: 小数点1桁まで（12.5 BTC）

### 強度評価（ツールが自動計算済み）
- ★★★：複数回の反発/反落実績あり、信頼性高
- ★★☆：実績あり、または出来高を伴う反発
- ★☆☆：転換候補、信頼性未確認

※ツールが自動判定：従来型は接触回数・直近の維持・出来高で評価、新形成は基本★★☆（出来高1.5倍以上で★★★）、転換型は基本★☆☆

### 絵文字使用
- ✅: 整合性あり、信頼性高い
- ⚠️: 注意が必要、リスクあり
- ❌: 整合性なし、機能しない可能性
- 📈: 上抜けシナリオ
- 📉: 下抜けシナリオ
- ⏸️: レンジ継続
- 🔴: レジスタンス
- 🟢: サポート
- 📍: 現在価格

### トーン
- 専門用語OK（中級者向け）
- 根拠は必ず数値で示す
- 断定を避け、「～の可能性」「～と推測される」等の表現を使用

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。`
        }]
      }
    ],
    metadata: {
      level: PromptLevel.INTERMEDIATE,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '1-2分',
      tags: ['intermediate', 'support', 'resistance', 'price-levels', 'orderbook', 'candles', 'comprehensive']
    }
  },
  {
    name: '🔰 最近のBTCの動きどう？',
    description: '🔰 超初心者向け：ビットコインの「今」を、4つの視点（価格・取引・勢い・見立て）からやさしく解説',
    messages: [
      {
        role: 'assistant', content: [{
          type: 'text', text: `ビットコイン相場の現状を、専門用語を使わずに丁寧に説明してください。
次の4ステップに沿って、初心者にもわかる文章でまとめてください。

# 📊 ビットコイン相場の現状（2025年XX月XX日）

⚠️ **最重要注意事項：contentを優先的に使用**
get_candles の**content**（人間向けサマリー）に、分析に必要な情報がすべて含まれています：
- 📊 期間別の価格推移（今日、7日前、30日前、90日前）+ 変化率
- 💰 出来高推移（直近7日間、その前7日間）+ 変化率 + 判定
- ⚠️ 配列の並び順の警告

**structuredContent.data を見る必要はありません。contentだけで分析を完了してください。**

配列の並び順について：
data[0] = 最古（90日前）、data[89] = 最新（今日）
**この並び順を逆に解釈すると、初心者を誤った方向に導く危険な誤りになります。**

━━━━━━━━━━━━━━━━━━━

## 1️⃣ 価格の動き（3つの期間で比較）

【使用ツール】
- get_candles(pair="btc_jpy", type="1day", limit=90)

【重要：contentに全情報が含まれています】
get_candles の content に、以下の情報が計算済みで含まれています：
- 今日、7日前、30日前、90日前の価格
- 各期間の変化率（%）
- 日付とデータのインデックス

**structuredContent.data を見る必要はありません。contentの情報をそのまま使ってください。**

【分析方法】
- content の「📊 期間別の価格推移」セクションから変化率を確認
- 判定基準：
   - +2%以上 → 上向き ↗️
   - -2%以下 → 下向き ↘️
   - ±2%以内 → 横ばい →
- 「一言説明」を追加

【contentに含まれる情報の例】
BTC/JPY [1day] ローソク足90本取得
⚠️ 配列は古い順: data[0]=最古、data[89]=最新

📊 期間別の価格推移:
- 今日 (2025-11-22, data[89]): ¥13,184,855
- 7日前 (2025-11-15, data[82]): ¥14,785,507 → 変化率 -10.8%
- 30日前 (2025-10-23, data[59]): ¥16,823,040 → 変化率 -21.8%
- 90日前 (2025-08-25, data[0]): ¥16,331,945 → 変化率 -19.4%

【出来高推移】
- 直近7日間の平均: 351 BTC/日
- その前7日間の平均: 245 BTC/日
- 出来高変化率: +42.8%
- 判定: 活発になっています

※ 全データは structuredContent.data に含まれます

【重要】このcontentの情報だけで、セクション1️⃣と2️⃣の出力を完成できます。
structuredContent.data を見る必要はありません。

【出力フォーマット】
**現在価格：¥XX,XXX,XXX**

**📈 短期（1週間）：[判定] [矢印]**  
   7日前: ¥XX,XXX,XXX → 今日: ¥XX,XXX,XXX（±X.X%）
💡 [初心者向けの一言説明]

**📊 中期（1ヶ月）：[判定] [矢印]**  
   30日前: ¥XX,XXX,XXX → 今日: ¥XX,XXX,XXX（±X.X%）
💡 [初心者向けの一言説明]

**📉 長期（3ヶ月）：[判定] [矢印]**  
   90日前: ¥XX,XXX,XXX → 今日: ¥XX,XXX,XXX（±X.X%）
💡 [初心者向けの一言説明]

【一言説明の例】
- 変化率 > +5%: 「この[期間]で大きく上がっています」
- 変化率 +2〜+5%: 「この[期間]で少しずつ上がってきています」
- 変化率 -2〜+2%: 「この[期間]はほとんど変わっていません」
- 変化率 -5〜-2%: 「この[期間]で少しずつ下がってきています」
- 変化率 < -5%: 「この[期間]で大きく下がっています」

## 2️⃣ 取引の活発さ

【使用ツール】
- 上記 get_candles の結果に含まれる「出来高推移」情報を利用
- **重要**: get_candles の content に出来高情報が既に計算済みで含まれています
  - 直近7日間の平均
  - その前7日間の平均
  - 出来高変化率
  - 判定（活発/普通/落ち着いている）

【分析方法】
- get_candles の content から「出来高推移」セクションを確認
- 判定結果をそのまま使用
- 初心者向けに言い換える

【出力フォーマット】

**💰 取引の活発さ：[判定]**
• 直近1週間: X,XXX BTC/日（前週比 ±XX.X%）
• 過去1ヶ月平均: X,XXX BTC/日

💡取引量は前週と比べて[ほぼ同じ/やや増加/やや減少]で、過去1ヶ月の平均的なペースです

## 3️⃣ 最近の買い/売りの勢い

【使用ツール】
- get_flow_metrics(pair="btc_jpy", bucketMs=60000, limit=100, view="summary")

【分析内容】
直近1時間の実際の取引（約定）における買い/売りの割合を確認：
- 買い注文での約定比率（buy%）
- 売り注文での約定比率（100 - buy%）
- 累積出来高差（CVD: Cumulative Volume Delta）

【分析方法】
1. get_flow_metrics の Totals から以下を取得：
   - buy%（買い注文での約定比率）
   - CVD（累積出来高差: 正なら買い優勢、負なら売り優勢）
2. 買い比率による判定：
   - 60%以上 → 「買いたい人の方が多く」
   - 40%未満 → 「売りたい人の方が多く」
   - 40-60% → 「買いと売りが拮抗しており」
3. CVDの正負で優勢方向を確認

【出力フォーマット】

**📊 直近1時間の取引傾向**
• 買い注文での約定: XX%
• 売り注文での約定: XX%
• 累積出来高差: ±X.XX BTC（買い優勢 / 売り優勢）

💡 [初心者向けの説明]

例：「直近1時間では買いたい人の方が多く、価格を押し上げる力が働いています」

【一言説明の例】
- 買い優勢（buy% ≥ 60）：「直近1時間では買いたい人の方が多く、価格を押し上げる力が働いています」
- 売り優勢（buy% < 40）：「直近1時間では売りたい人の方が多く、価格を押し下げる力が働いています」
- 拮抗（40 ≤ buy% < 60）：「直近1時間では買いと売りが拮抗しており、方向感が定まっていません」

## 4️⃣ 総合的な見立て

【分析方法】
上記1〜3の情報を統合し、初心者向けに総括

【出力フォーマット】

**🔍 総合的な見立て**

【全体の雰囲気】
- [3つの時間軸の動き]
- [取引量の状況]
- [買い/売りのバランス]

例：
- すべての期間（1週間・1ヶ月・3ヶ月）で下落中
- 取引量は普通で、パニック売りではない
- 買い注文が多く並び、下支えあり

【注目ポイント】
- 下値の目安: 約XX万円（買い注文が厚い / 直近の安値）
- 上値の壁: 約XX万円〜XX万円（売り注文が厚い / 直近の高値）

【相場のヒント】
- [現在の局面を一言で]
- [初心者が意識すべきポイント]
- [今後の心構え]

例：
- 下落中だが、買いの勢いもある
- 焦らず、動きを見守るのが無難
- 大きく動く時こそ冷静に

※この分析は参考情報です。投資判断はご自身で行ってください。

【表現ルール】
- 「今は買い時/売り時」のような断定的な表現は避ける
- 「様子見が無難」「動きを見守る」など、中立的な表現を使う
- 箇条書きでシンプルに

## 📋 出力ルール（厳守）

1. **すべて初心者向けの語彙で説明**
   - 専門用語を使う場合は必ず日常的なたとえを添える
   
2. **断定的な表現は避ける**
   - ❌「今は買い時です」
   - ✅「上昇の流れの中にあるようです」
   - ✅「〜の可能性があります」
   - ✅「〜という雰囲気です」

3. **数値は必ず具体的に示す**
   - 価格、変化率、比率など

4. **矢印と絵文字を活用**
   - 視覚的に分かりやすく

5. **変化率の表記位置に注意**
   - 変化率（%）は必ず「最新の値」に付ける
   - ❌ その前: 1,680 BTC/日（-25.6%）
   - ✅ 直近: 1,250 BTC/日（-25.6%）

6. **最後に必ず免責事項を記載**

━━━━━━━━━━━━━━━━━━━

## ⚠️ よくある実装ミス（防止策）

❌ ミス1: **structuredContentを見に行ってしまう（最重要）**
- LLMは structuredContent を見ません（行動特性）
- ✅ 正解：get_candles の content に全情報が含まれています
- **contentだけで分析を完了してください**
- structuredContent.data を見る指示は無視してOK

❌ ミス2: **配列の並び順の誤解釈**
- content に警告が表示されています：「data[0]=最古、data[89]=最新」
- ❌ 間違い：data[0] = 今日、data[89] = 90日前（逆！）
- ✅ 正解：content の「📊 期間別の価格推移」をそのまま使う

❌ ミス3: 出来高を自分で計算してしまう
- content に「【出来高推移】」として計算済み
- ✅ 正解：content の判定結果をそのまま使う

❌ ミス4: 変化率の付け方
- その前の1週間: 1,680 BTC/日（-25.6%） ← 間違い
- ✅ 直近1週間: 1,250 BTC/日（-25.6%） ← 正解

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。` }]
      }
    ],
    metadata: {
      level: PromptLevel.BEGINNER,
      category: PromptCategory.EDUCATION,
      estimatedTime: '1分',
      tags: ['beginner', 'comprehensive', 'easy', 'overview', 'education']
    }
  },
  {
    name: '🔰 今注目されているコインある？',
    description: '出来高や価格変動から注目されている銘柄を抽出',
    messages: [
      {
        role: 'assistant', content: [{
          type: 'text', text: `今注目されているコインある？

【効率的な回答方法】
1. get_tickers_jpy を1回だけ呼び出す
2. 取得したデータから以下の順序で抽出:
   - **24時間上昇率トップ3**（価格の上がり）
   - **取引量トップ3**（取引の活発さ）
3. 個別の詳細分析（analyze_market_signal等）は不要

【出力フォーマット】

## 24時間上昇率トップ3

1. XYM（シンボル）  
   a. 価格：1.03円  
   b. 24時間の変化率：**+21.32%**  
   c. 24h取引量：9,648万円

2. （次のコイン）  
   ...

## 取引量トップ3

1. BTC（ビットコイン）  
   a. 価格：13,709,888円  
   b. 24時間の変化率：+0.83%  
   c. 24h取引量：**38.8億円**

2. （次のコイン）  
   ...

【フォーマットルール】
- 項目番号: 1, 2, 3（各セクション内で）
- サブ項目: a, b, c（各行の末尾にスペース2つで改行）
- 24時間上昇率トップ3: 「b. 24時間の変化率」を**太字**で強調
- 取引量トップ3: 「c. 24h取引量」を**太字**で強調
- 価格は「円」表記（¥マークは使わない）
- チャートは不要

---

⚠️ 免責事項：この分析は参考情報であり、解釈には誤差が含まれる場合があります。

板情報は秒単位で変動するため、実際のトレード前には最新状況を再確認してください。

投資判断はご自身の責任でお願いします。` }]
      }
    ],
    metadata: {
      level: PromptLevel.BEGINNER,
      category: PromptCategory.ANALYSIS,
      estimatedTime: '30秒',
      tags: ['beginner', 'ranking', 'volume', 'attention']
    }
  },


  {
    name: 'test_simple',
    description: 'テスト用シンプルPrompt',
    messages: [
      {
        role: 'user',
        content: [
          { type: 'text', text: 'ビットコインの現在の価格を教えてください。' }
        ]
      }
    ],
    metadata: {
      level: PromptLevel.BEGINNER,
      category: PromptCategory.ANALYSIS,
      tags: ['test']
    }
  },
  // === Beginner analysis-only prompts (tools only; no chart rendering) ===



];


// 日本語名のプロンプトのみを MCP に公開（英語名は非表示）
// 日本語名のみ + 指定順に並べ替えて公開
const desiredOrder = [
  '🔰 最近のBTCの動きどう？',
  '🔰 BTCの値動きを分析して',
  '🔰 ビットコインは今後どうなりそう？',
  '🔰 今のBTCって買い時？',
  '🔰 今注目されているコインある？',
  '中級：主要指標でBTCを分析して',
  '中級：BTCのフロー分析をして',
  '中級：BTCの板の状況を詳しく見て',
  '中級：BTCのパターン分析をして',
  '中級：BTCのサポレジを分析して',
];
const orderIndex = (name: string) => {
  const i = desiredOrder.indexOf(name);
  return i >= 0 ? i : Number.MAX_SAFE_INTEGER;
};
export const prompts: PromptDef[] = promptsAll
  .filter(p => /[^\x00-\x7F]/.test(p.name))
  .sort((a, b) => orderIndex(a.name) - orderIndex(b.name));
